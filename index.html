<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>峠 Gestﾃ｣o de Rﾃ｡dios</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Bibliotecas para Leitura de Arquivos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Configuraﾃｧﾃ｣o do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'green-main': '#40800c', /* Novo verde principal: 40800c */
                    }
                }
            }
        }
    </script>
    <style>
        html { font-family: 'Inter', 'sans-serif'; }
        
        /* Cor de destaque com transparﾃｪncia */
        :root {
            --green-alpha: rgba(64, 128, 12, 0.4); /* 40800c com 40% de opacidade */
        }

        .tab-active { border-bottom-width: 2px; border-color: #40800c; }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
        }
        
        /* Efeito de Transiﾃｧﾃ｣o da Tela de Loading - Imagem Cheia */
        .loader-logo-full {
            opacity: 0;
            animation: fadeIn 1s ease-out forwards;
            animation-delay: 0.5s;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        /* Estilo para os cards do dashboard com o novo verde */
        .futuristic-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), inset 0 0 8px var(--green-alpha);
        }
        .futuristic-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), inset 0 0 12px var(--green-alpha);
        }

        /* Animaﾃｧﾃ｣o para o texto de loading */
        .loading-text-animate {
            animation: pulse-text 1.5s infinite ease-in-out;
        }
        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>

    <!-- Root da Aplicaﾃｧﾃ｣o -->
    <div id="app" class="min-h-screen bg-gray-50">
        <!-- O conteﾃｺdo serﾃ｡ injetado aqui pelo JavaScript -->
    </div>

    <!-- Modal de Confirmaﾃｧﾃ｣o/Alerta -->
    <div id="global-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all scale-100 opacity-100 p-6">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-3">Aviso</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <!-- Botﾃｵes serﾃ｣o injetados aqui -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importaﾃｧﾃｵes do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut,
            updatePassword 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            writeBatch,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuraﾃｧﾃ｣o e Variﾃ｡veis Globais do Firebase ---
        let app, auth, db;
        
        // [CORREﾃﾃグ] Usando a constante FIREBASE_CONFIG e o appId hardcoded
        // Exatamente como no seu Teste.test.html original
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCb0Dhh_eMHrs_Dyg1wS5nbMu1U6tKHa3A",
            authDomain: "gestaoradios-58b0a.firebaseapp.com",
            projectId: "gestaoradios-58b0a",
            storageBucket: "gestaoradios-58b0a.firebasestorage.app",
            messagingSenderId: "359260635463",
            appId: "1:359260635463:web:1c3ac47eebcd3434818c62",
            measurementId: "G-DVXXT79TZK"
        };
        const appId = "gestaoradios-58b0a"; // [CORREﾃﾃグ] appId hardcoded
        
        let userId;
        let isAuthReady = false;	
        let firestoreListeners = [];	

        // --- Variﾃ｡veis de Estado Global (App) ---
        let currentUser = null;	
        let currentPage = 'login';
        let currentCadastroTab = 'radio';
        let currentSettingTab = 'my-profile'; 
        let isLoggingIn = false;

        // Paginaﾃｧﾃ｣o e Busca
        let radioPage = 1, equipamentoPage = 1, geralPage = 1;
        const PAGE_SIZE = 6;
        let radioSearch = '', equipamentoSearch = '', geralSearch = '';
        let focusedSearchInputId = null;
        let searchCursorPosition = 0;

        // Constantes de Configuraﾃｧﾃ｣o
        const GROUPS = ['Colheita', 'Transporte', 'Oficina', 'TPL', 'Industria'];
        const DEFAULT_LETTER_MAP = {
            Colheita: 'A',
            Transporte: 'B',
            Oficina: 'NUM',
            TPL: 'D',
            Industria: 'C'
        };
        const DEFAULT_NEXT_INDEX = { A: 1, B: 1, C: 1, D: 1, NUM: 1 };

        // --- Estado do Banco de Dados (In-memory Cache) ---
        let dbRadios = [];
        let dbEquipamentos = [];
        let dbRegistros = [];
        let settings = {
            letterMap: DEFAULT_LETTER_MAP,
            nextIndex: DEFAULT_NEXT_INDEX,
            users: []	
        };

        // --- Funﾃｧﾃｵes de Utilitﾃ｡rio e Estado ---
        function detachFirestoreListeners() {
            firestoreListeners.forEach(unsub => unsub());
            firestoreListeners = [];
        }

        async function attachFirestoreListeners() {
            detachFirestoreListeners();	
            if (!db || !appId || !currentUser) return;

            // 1. Carregar Configuraﾃｧﾃｵes
            // [CORREﾃﾃグ] Usa appId hardcoded
            const settingsDocRef = doc(db, "artifacts", appId, "public", "data", "settings", "config");
            try {
                const settingsSnap = await getDoc(settingsDocRef);
                if (settingsSnap.exists()) {
                    const data = settingsSnap.data();
                    settings.letterMap = data.letterMap || DEFAULT_LETTER_MAP;
                    settings.nextIndex = data.nextIndex || DEFAULT_NEXT_INDEX;
                    settings.users = data.users || []; // Garante que a lista de usuﾃ｡rios ﾃｩ carregada
                } else {
                    console.warn("Documento de 'settings/config' nﾃ｣o encontrado. Criando um novo com padrﾃｵes.");
                    // Define um usuﾃ｡rio admin padrﾃ｣o se nﾃ｣o houver configuraﾃｧﾃｵes
                    settings.users = settings.users.length === 0 ? [{ 
                        id: crypto.randomUUID(), 
                        name: "Juliano Timoteo", 
                        username: "monitoramentocoa1986@gmail.com", 
                        role: "admin",
                        permissions: { dashboard: true, cadastro: true, pesquisa: true, settings: true }
                    }] : settings.users;
                    await saveSettings();	
                }
            } catch (e) {
                console.error("Erro ao carregar 'settings/config':", e);
                showModal('Erro Crﾃｭtico', 'Nﾃ｣o foi possﾃｭvel carregar as configuraﾃｧﾃｵes do sistema.', 'error');
            }

            // 2. Sincronizar Coleﾃｧﾃｵes
            const collectionsToSync = {
                'radios': (data) => dbRadios = data,
                'equipamentos': (data) => dbEquipamentos = data,
                'registros': (data) => dbRegistros = data
            };

            Object.keys(collectionsToSync).forEach(colName => {
                // [CORREﾃﾃグ] Usa appId hardcoded
                const colPath = `artifacts/${appId}/public/data/${colName}`;
                const q = query(collection(db, colPath));
                
                const unsub = onSnapshot(q, (querySnapshot) => {
                    const data = [];
                    querySnapshot.forEach((doc) => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    
                    collectionsToSync[colName](data);	
                    
                    if(isAuthReady) {
                        renderApp();
                    }

                }, (error) => {
                    console.error(`Erro no listener de ${colName}:`, error);
                    showModal('Erro de Sincronia', `Nﾃ｣o foi possﾃｭvel carregar dados de ${colName}.`, 'error');
                });
                firestoreListeners.push(unsub);
            });
            
            // 3. Forﾃｧa renderizaﾃｧﾃ｣o
            handleHashChange();
        }

        async function saveSettings() {
            if (!db || !appId) return;
            // [CORREﾃﾃグ] Usa appId hardcoded
            const settingsDocRef = doc(db, "artifacts", appId, "public", "data", "settings", "config");
            try {
                await setDoc(settingsDocRef, {	
                    letterMap: settings.letterMap,
                    nextIndex: settings.nextIndex,
                    users: settings.users // Salva a lista de usuﾃ｡rios
                }, { merge: true });
            } catch (e) {
                console.error("Erro ao salvar 'settings/config':", e);
                showModal('Erro', 'Nﾃ｣o foi possﾃｭvel salvar as configuraﾃｧﾃｵes no banco de dados.', 'error');
            }
        }
        
        function updateState(key, value) {
            switch (key) {
                case 'page':
                    if (value === 'login' && currentUser) return;
                    if (value !== 'login' && !currentUser) {
                        currentPage = 'login';
                        window.location.hash = '#login';
                        return;
                    }
                    currentPage = value;
                    currentCadastroTab = 'radio';	
                    currentSettingTab = 'my-profile'; // Resetar para o padrﾃ｣o
                    radioPage = 1; equipamentoPage = 1; geralPage = 1;
                    radioSearch = ''; equipamentoSearch = ''; geralSearch = '';
                    focusedSearchInputId = null;	
                    break;
                case 'cadastroTab':
                    currentCadastroTab = value;
                    focusedSearchInputId = null;
                    break;
                case 'settingTab':
                    currentSettingTab = value;
                    focusedSearchInputId = null;
                    break;
                case 'settings':	
                    settings = value;
                    break;
            }
            
            let hash = `#${currentPage}`;
            if (currentPage === 'cadastro') hash = `#${currentPage}/${currentCadastroTab}`;
            else if (currentPage === 'settings') hash = `#${currentPage}/${currentSettingTab}`;
            
            if (window.location.hash.substring(1) !== hash.substring(1)) {
                window.location.hash = hash;
            } else {
                renderApp();	
            }
        }
        
        // --- Funﾃｧﾃｵes de Geraﾃｧﾃ｣o de Cﾃｳdigo ---

        function zpad(n, size) {	
            return String(n).padStart(size, '0');	
        }

        function generateCode(group) {
            const letterMap = settings.letterMap;
            const nextIndex = settings.nextIndex;
            const letter = letterMap[group];
            
            if (!letter) {
                showModal('Erro', `Mapeamento de letra nﾃ｣o encontrado para o grupo: ${group}`, 'error');
                return null;
            }

            const indexKey = letter === 'NUM' ? 'NUM' : letter;
            let index = nextIndex[indexKey] || 1;	
            let code;

            if (letter === 'NUM') code = zpad(index, 3);
            else code = letter + zpad(index, 3);
            
            nextIndex[indexKey] = index + 1;
            settings.nextIndex = nextIndex;	
            
            saveSettings();	

            return code;
        }

        // --- Funﾃｧﾃｵes de CRUD ---

        async function saveRecord(collectionName, record) {
            if (!db || !appId) {
                showModal('Erro', 'Conexﾃ｣o com o banco de dados perdida.', 'error');
                return;
            }
            
            // [CORREﾃﾃグ] Usa appId hardcoded
            const colPath = `artifacts/${appId}/public/data/${collectionName}`;
            let recordData = { ...record };	

            try {
                if (recordData.id) {
                    // Update
                    const docRef = doc(db, colPath, recordData.id);
                    delete recordData.id;	
                    await setDoc(docRef, recordData, { merge: true });
                    showModal('Sucesso', 'Registro atualizado com sucesso!', 'success');
                } else {
                    // Create
                    recordData.createdAt = new Date().toISOString();
                    if (collectionName === 'radios' || collectionName === 'equipamentos') {
                        recordData.ativo = true;
                    }
                    if (collectionName === 'radios') {
                        recordData.status = recordData.status || 'Disponﾃｭvel';
                    }
                    delete recordData.id;	
                    await addDoc(collection(db, colPath), recordData);
                    showModal('Sucesso', 'Registro adicionado com sucesso!', 'success');
                }
            } catch (error) {
                console.error("Erro ao salvar registro:", error);
                showModal('Erro', 'Nﾃ｣o foi possﾃｭvel salvar o registro no banco de dados.', 'error');
            }
        }

        async function deleteRecord(collectionName, id) {
            if (!db || !appId) {
                showModal('Erro', 'Conexﾃ｣o com o banco de dados perdida.', 'error');
                return;
            }
            
            // [CORREﾃﾃグ] Usa appId hardcoded
            const colPath = `artifacts/${appId}/public/data/${collectionName}`;

            try {
                // Lﾃｳgica mantida apenas para DESVINCULAﾃﾃグ na aba 'Geral'
                if (collectionName === 'registros') {
                    // DESVINCULAﾃﾃグ
                    const regRef = doc(db, colPath, id);
                    const regSnap = await getDoc(regRef);	

                    if (!regSnap.exists()) {
                        showModal('Erro', 'Registro nﾃ｣o encontrado para desvinculaﾃｧﾃ｣o.', 'error');
                        return;
                    }

                    const registroRemovido = regSnap.data();
                    await deleteDoc(regRef);
                    
                    if (registroRemovido && registroRemovido.radioId) {
                        // [CORREﾃﾃグ] Usa appId hardcoded
                        const radioRef = doc(db, `artifacts/${appId}/public/data/radios`, registroRemovido.radioId);
                        await updateDoc(radioRef, { status: 'Disponﾃｭvel' });
                    }
                    
                    showModal('Sucesso', 'Rﾃ｡dio desvinculado com sucesso!', 'success');
                
                } else {
                    // Lﾃｳgica de inativaﾃｧﾃ｣o foi movida para toggleRecordAtivo
                    showModal('Erro', 'Aﾃｧﾃ｣o nﾃ｣o suportada.', 'error');
                }
            } catch (error) {
                console.error("Erro ao deletar/inativar registro:", error);
                showModal('Erro', 'Ocorreu um erro durante a operaﾃｧﾃ｣o.', 'error');
            }
        }
        
        async function toggleRecordAtivo(collectionName, id) {
            if (!db || !appId || (collectionName !== 'radios' && collectionName !== 'equipamentos')) {
                showModal('Erro', 'Aﾃｧﾃ｣o invﾃ｡lida.', 'error');
                return;
            }
            
            // [CORREﾃﾃグ] Usa appId hardcoded
            const colPath = `artifacts/${appId}/public/data/${collectionName}`;

            try {
                const docRef = doc(db, colPath, id);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    showModal('Erro', 'Registro nﾃ｣o encontrado.', 'error');
                    return;
                }

                const currentData = docSnap.data();
                // Alterna o estado. Se ativo for false, vira true. Se for true ou undefined, vira false.
                const newAtivoState = !(currentData.ativo !== false);	

                // Se estﾃ｡ tentando INATIVAR, checa as regras de bloqueio
                if (newAtivoState === false) {	
                    if (collectionName === 'radios' && dbRegistros.some(reg => reg.radioId === id)) {
                        showModal('Aﾃｧﾃ｣o Bloqueada', 'Nﾃ｣o ﾃｩ possﾃｭvel inativar um rﾃ｡dio que estﾃ｡ vinculado.\n\nDesvincule na aba "Geral" primeiro.', 'error');
                        return;
                    }
                    if (collectionName === 'equipamentos' && dbRegistros.some(reg => reg.equipamentoId === id)) {
                        showModal('Aﾃｧﾃ｣o Bloqueada', 'Nﾃ｣o ﾃｩ possﾃｭvel inativar um equipamento que possui um rﾃ｡dio vinculado.\n\nDesvincule na aba "Geral" primeiro.', 'error');
                        return;
                    }
                }
                
                // Atualiza o status
                await updateDoc(docRef, { ativo: newAtivoState });	
                showModal('Sucesso', `Registro ${newAtivoState ? 'ATIVADO' : 'INATIVADO'} com sucesso!`, 'success');
                // renderApp() ﾃｩ chamado automaticamente pelo onSnapshot
                
            } catch (error) {
                console.error("Erro ao alternar status do registro:", error);
                showModal('Erro', 'Ocorreu um erro durante a operaﾃｧﾃ｣o.', 'error');
            }
        }
        
        // --- NOVO: Funﾃｧﾃｵes de CRUD de Usuﾃ｡rio ---

        function loadUserForEdit(id) {
            const user = settings.users.find(u => u.id === id);
            if (user) {
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-name').value = user.name;
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-form-title').textContent = 'Editar Perfil de Usuﾃ｡rio';
                showModal('Ediﾃｧﾃ｣o', `Carregando perfil de ${user.name} para ediﾃｧﾃ｣o.`, 'info');
                window.scrollTo(0, 0);
            } else {
                showModal('Erro', 'Usuﾃ｡rio nﾃ｣o encontrado.', 'error');
            }
        }

        async function saveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const name = document.getElementById('user-name').value.trim();
            const username = document.getElementById('user-username').value.trim(); // Email
            const role = document.getElementById('user-role').value;
            
            if (!name || !username || !role) {
                showModal('Erro', 'Nome, Username (Email) e Perfil sﾃ｣o obrigatﾃｳrios.', 'error');
                return;
            }
            
            // Validaﾃｧﾃｵes de email bﾃ｡sico
            if (!username.includes('@') || !username.includes('.')) {
                showModal('Erro', 'Username deve ser um email vﾃ｡lido.', 'error');
                return;
            }

            const usersFromDB = settings.users;
            const isEditing = !!id;
            
            // Checagem de duplicidade (apenas se for novo OU se o email for alterado na ediﾃｧﾃ｣o)
            const isDuplicate = usersFromDB.some(u => 
                u.username === username && (!isEditing || u.id !== id)
            );

            if (isDuplicate) {
                showModal('Erro', 'Este Username/Email jﾃ｡ estﾃ｡ em uso por outro perfil.', 'error');
                return;
            }
            
            let userToSave;
            if (isEditing) {
                userToSave = usersFromDB.find(u => u.id === id);
                if (!userToSave) {
                    showModal('Erro', 'Erro ao encontrar usuﾃ｡rio para ediﾃｧﾃ｣o.', 'error');
                    return;
                }
                userToSave.name = name;
                userToSave.username = username;
                userToSave.role = role;
                // Mantﾃｩm as permissﾃｵes existentes
            } else {
                // Novo usuﾃ｡rio
                userToSave = { 
                    id: crypto.randomUUID(), // Novo ID ﾃｺnico
                    name, 
                    username, 
                    role, 
                    permissions: {} // Permissﾃｵes padrﾃ｣o vazias
                };
                usersFromDB.push(userToSave);
            }
            
            // Definiﾃｧﾃ｣o de permissﾃｵes padrﾃ｣o para um novo usuﾃ｡rio ou se o perfil mudou para admin
            if (!isEditing || role === 'admin') {
                userToSave.permissions = {
                    dashboard: true, cadastro: true, pesquisa: true, settings: role === 'admin'
                };
            }
            
            // Salva a lista completa no Firestore
            const settingsDocRef = doc(db, "artifacts", appId, "public", "data", "settings", "config");
            try {
                await setDoc(settingsDocRef, { users: usersFromDB }, { merge: true });
                showModal('Sucesso', `Perfil de ${name} ${isEditing ? 'atualizado' : 'cadastrado'} com sucesso!`, 'success');
                
                // Limpa formulﾃ｡rio e forﾃｧa renderizaﾃｧﾃ｣o
                document.getElementById('form-user').reset();
                document.getElementById('user-id').value = '';
                document.getElementById('user-form-title').textContent = 'Novo Perfil de Usuﾃ｡rio';
                renderApp(); 
            } catch (e) {
                console.error("Erro ao salvar perfil de usuﾃ｡rio:", e);
                showModal('Erro', 'Nﾃ｣o foi possﾃｭvel salvar o perfil no banco de dados.', 'error');
            }
        }

        async function deleteUser(id) {
            const settingsDocRef = doc(db, "artifacts", appId, "public", "data", "settings", "config");
            let usersFromDB = settings.users;
            const userIndex = usersFromDB.findIndex(u => u.id === id);
            
            if (userIndex === -1) {
                showModal('Erro', 'Usuﾃ｡rio nﾃ｣o encontrado para exclusﾃ｣o.', 'error');
                return;
            }

            const userName = usersFromDB[userIndex].name;
            const userUsername = usersFromDB[userIndex].username;

            // Bloqueia exclusﾃ｣o do admin principal
            if (userUsername === 'monitoramentocoa1986@gmail.com') {
                showModal('Bloqueado', 'O usuﾃ｡rio principal (Admin) nﾃ｣o pode ser excluﾃｭdo.', 'warning');
                return;
            }
            
            usersFromDB.splice(userIndex, 1); // Remove o usuﾃ｡rio
            
            try {
                // Salva a lista completa (sem o usuﾃ｡rio removido) no Firestore
                await setDoc(settingsDocRef, { users: usersFromDB }, { merge: true });
                showModal('Sucesso', `Perfil de ${userName} excluﾃｭdo com sucesso!`, 'success');
                renderApp(); 
            } catch (e) {
                console.error("Erro ao excluir perfil de usuﾃ｡rio:", e);
                showModal('Erro', 'Nﾃ｣o foi possﾃｭvel excluir o perfil no banco de dados.', 'error');
            }
        }

        // --- NOVAS FUNﾃﾃ髭S: Gerenciamento Pessoal (Meu Perfil) ---

        async function savePersonalName(e) {
            e.preventDefault();
            const newName = document.getElementById('profile-name').value.trim();
            if (!newName) {
                showModal('Erro', 'O nome de exibiﾃｧﾃ｣o nﾃ｣o pode ser vazio.', 'error');
                return;
            }
            
            const usersFromDB = settings.users;
            const userIndex = usersFromDB.findIndex(u => u.username === currentUser.email);

            if (userIndex === -1) {
                showModal('Erro', 'Seu perfil nﾃ｣o foi encontrado no banco de dados.', 'error');
                return;
            }

            usersFromDB[userIndex].name = newName;
            
            const settingsDocRef = doc(db, "artifacts", appId, "public", "data", "settings", "config");
            try {
                await setDoc(settingsDocRef, { users: usersFromDB }, { merge: true });
                // Atualiza o estado local do usuﾃ｡rio e forﾃｧa renderizaﾃｧﾃ｣o
                currentUser.name = newName;
                showModal('Sucesso', 'Nome de exibiﾃｧﾃ｣o atualizado com sucesso!', 'success');
                renderApp();
            } catch (e) {
                console.error("Erro ao salvar nome pessoal:", e);
                showModal('Erro', 'Nﾃ｣o foi possﾃｭvel salvar o seu nome.', 'error');
            }
        }

        async function changePassword(e) {
            e.preventDefault();
            const newPassword = document.getElementById('profile-new-password').value;
            const confirmPassword = document.getElementById('profile-confirm-password').value;

            if (newPassword.length < 6) {
                showModal('Erro', 'A nova senha deve ter pelo menos 6 caracteres.', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showModal('Erro', 'As senhas nﾃ｣o coincidem.', 'error');
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                showModal('Erro', 'Usuﾃ｡rio nﾃ｣o autenticado.', 'error');
                return;
            }

            try {
                // O Firebase Auth cuida da reautenticaﾃｧﾃ｣o se necessﾃ｡rio.
                await updatePassword(user, newPassword);
                showModal('Sucesso', 'Senha alterada com sucesso! Vocﾃｪ pode ser solicitado a fazer login novamente.', 'success');
                document.getElementById('form-change-password').reset();
            } catch (error) {
                console.error("Erro ao trocar senha:", error.code);
                let msg = 'Ocorreu um erro ao trocar a senha.';
                if (error.code === 'auth/requires-recent-login') {
                    msg = 'A troca de senha falhou. Por favor, faﾃｧa login novamente e tente de novo.';
                } else if (error.code === 'auth/weak-password') {
                    msg = 'A senha ﾃｩ muito fraca. Escolha uma senha mais forte.';
                }
                showModal('Erro de Senha', msg, 'error');
            }
        }
        
        // --- FIM NOVAS FUNﾃﾃ髭S: Gerenciamento Pessoal (Meu Perfil) ---

        // --- Funﾃｧﾃｵes de Importaﾃｧﾃ｣o ---
        // ... (resto das funﾃｧﾃｵes de importaﾃｧﾃ｣o)

        function handleImport(collection, event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = e.target.result;
                let parsedData = [];

                if (file.name.endsWith('.csv')) {
                    Papa.parse(data, {
                        header: true, skipEmptyLines: true,
                        complete: function(results) {
                            processImportedData(collection, results.data);
                        }
                    });
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    parsedData = XLSX.utils.sheet_to_json(worksheet);
                    processImportedData(collection, parsedData);
                } else {
                    showModal('Erro', 'Formato de arquivo nﾃ｣o suportado. Use CSV ou XLSX.', 'error');
                }
            };
            
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) reader.readAsBinaryString(file);
            else reader.readAsText(file);
        }

        async function processImportedData(collectionName, data) {
            if (!db || !appId) {
                showModal('Erro', 'Conexﾃ｣o com o banco de dados perdida.', 'error');
                return;
            }

            const newRecords = [];
            let currentDb = collectionName === 'radios' ? dbRadios : dbEquipamentos;

            for (const item of data) {
                let record = { createdAt: new Date().toISOString(), ativo: true };
                
                if (collectionName === 'radios') {
                    const serie = item['Numero de Serie'] || item['Numero deSerie'] || item['serie'];
                    const modelo = item['Modelo'] || item['Modelo de Radio'] || item['modelo'];
                    
                    if (!serie || !modelo) continue;
                    
                    record.serie = String(serie).trim();
                    record.modelo = String(modelo).trim();
                    record.status = 'Disponﾃｭvel';	

                    if (currentDb.some(r => r.serie === record.serie)) {
                        console.warn(`Rﾃ｡dio duplicado (cache local): ${record.serie}. Ignorando.`);
                        continue;	
                    }
                    
                } else if (collectionName === 'equipamentos') {
                    const frota = item['Frota'];
                    const grupo = item['Grupo'];
                    const modeloEq = item['Modelo do Equipamento'] || item['Modelo Equipamento'];
                    const subgrupo = item['Subgrupo'] || item['Descricao do Equipamento'] || item['Descricao Equipamento'];
                    const gestor = item['Gestor'] || 'Sem Gestor';
                    
                    if (!frota || !grupo || !modeloEq || !subgrupo || !GROUPS.includes(String(grupo).trim())) {
                        console.warn('Registro de equipamento invﾃ｡lido:', item);
                        continue;
                    }

                    record.frota = String(frota).trim();
                    record.grupo = String(grupo).trim();
                    record.modelo = String(modeloEq).trim();
                    record.subgrupo = String(subgrupo).trim();	
                    record.gestor = String(gestor).trim();
                    
                    if (currentDb.some(r => r.frota === record.frota)) {
                        console.warn(`Equipamento duplicado (cache local): ${record.frota}. Ignorando.`);
                        continue;	
                    }
                }
                newRecords.push(record);
            }

            if (newRecords.length > 0) {
                // [CORREﾃﾃグ] Usa appId hardcoded
                const colPath = `artifacts/${appId}/public/data/${collectionName}`;
                const colRef = collection(db, colPath);
                const batch = writeBatch(db);
                
                newRecords.forEach(record => {
                    const newDocRef = doc(colRef);	
                    batch.set(newDocRef, record);
                });

                try {
                    await batch.commit();
                    showModal('Importaﾃｧﾃ｣o Concluﾃｭda', `${newRecords.length} registros de ${collectionName} importados com sucesso.`, 'success');
                } catch (error) {
                    console.error("Erro ao salvar importaﾃｧﾃ｣o em lote:", error);
                    showModal('Erro de Importaﾃｧﾃ｣o', 'Ocorreu um erro ao salvar os dados no banco de dados.', 'error');
                }
            } else {
                showModal('Importaﾃｧﾃ｣o', 'Nenhum registro novo vﾃ｡lido foi encontrado no arquivo.', 'info');
            }
        }

        // --- Funﾃｧﾃｵes de Modal ---
        function showModal(title, message, type = 'info') {
            const modal = document.getElementById('global-modal');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const actionsEl = document.getElementById('modal-actions');

            titleEl.textContent = title;
            messageEl.innerHTML = message.replace(/\n/g, '<br>');
            
            let titleClass = 'text-gray-800';
            // Usando a nova cor principal
            if (type === 'success') titleClass = 'text-green-main';
            if (type === 'error') titleClass = 'text-red-600';
            if (type === 'warning') titleClass = 'text-yellow-600';
            titleEl.className = `text-xl font-bold mb-3 ${titleClass}`;

            actionsEl.innerHTML = `
                <button onclick="hideModal()" class="px-3 py-1.5 text-sm bg-green-main text-white font-semibold rounded-lg hover:bg-green-700 transition-colors shadow-md">
                    OK
                </button>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function showConfirmModal(title, message, callback) {
            const modal = document.getElementById('global-modal');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const actionsEl = document.getElementById('modal-actions');

            titleEl.textContent = title;
            messageEl.innerHTML = message.replace(/\n/g, '<br>');
            titleEl.className = `text-xl font-bold mb-3 text-red-600`;	

            actionsEl.innerHTML = `
                <button onclick="hideModal()" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors shadow-md">
                    Cancelar
                </button>
                <button id="confirm-action-btn" class="px-3 py-1.5 text-sm bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors shadow-md">
                    Confirmar
                </button>
            `;
            
            document.getElementById('confirm-action-btn').onclick = () => {
                hideModal();
                callback();	
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideModal() {
            document.getElementById('global-modal').classList.add('hidden');
            document.getElementById('global-modal').classList.remove('flex');
        }

        // --- NOVA FUNﾃﾃグ PARA AVATAR/IMAGEM DE PERFIL ---
        function getUserAvatar(user) {
            const defaultColor = 'bg-indigo-500';
            // Pega as iniciais do nome
            const initials = (user.name || 'NN').split(' ').map(n => n[0]).join('').toUpperCase();
            // Simula URL de foto (se disponﾃｭvel no objeto user, embora nﾃ｣o seja comum no Auth sem provedor social)
            const photoURL = user.photoURL || null; 

            if (photoURL) {
                return `<img src="${photoURL}" alt="Avatar de ${user.name}" class="h-8 w-8 rounded-full object-cover shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/32x32/40800c/FFFFFF?text=${initials}';">`;
            }

            return `
                <div class="h-8 w-8 rounded-full ${defaultColor} flex items-center justify-center text-white font-bold text-sm shadow-md ring-2 ring-green-main/50">
                    ${initials}
                </div>
            `;
        }
        
        // --- Funﾃｧﾃｵes de Renderizaﾃｧﾃ｣o (HTML) ---
        
        function renderTopBar() {
            const allTabs = [
                { id: 'dashboard', name: 'Dashboard', icon: 'fa-chart-line' },
                { id: 'cadastro', name: 'Cadastro', icon: 'fa-box' },
                { id: 'pesquisa', name: 'Pesquisa', icon: 'fa-search' },
                { id: 'settings', name: 'Configuraﾃｧﾃｵes', icon: 'fa-cog' }
            ];
            
            const tabs = allTabs.filter(tab => {
                if (!currentUser) return false;
                if (currentUser.role === 'admin') return true;	
                if (currentUser.permissions) return currentUser.permissions[tab.id] === true;
                return tab.id === 'dashboard' || tab.id === 'pesquisa';
            });
            
            const tabLinks = tabs.map(tab => {
                const isActive = currentPage === tab.id;
                const activeClass = isActive ? 'text-green-main tab-active font-semibold' : 'text-gray-500 hover:text-green-main';
                
                return `
                    <a href="#${tab.id}" class="py-3 px-4 flex items-center space-x-2 ${activeClass} transition-colors border-b-2 border-transparent">
                        <i class="fas ${tab.icon}"></i>
                        <span class="hidden sm:inline">${tab.name}</span>
                    </a>
                `;
            }).join('');

            return `
                <header class="bg-white shadow-lg sticky top-0 z-10 border-b border-gray-100">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between h-16 items-center">
                            
                            <!-- Logo e Tﾃｭtulo (Mobile Centralizado, Desktop ﾃ Esquerda) -->
                            <div class="flex-1 flex justify-start items-center">
                                <h1 class="text-xl font-bold text-gray-800 hidden sm:block">峠 Gestﾃ｣o de Rﾃ｡dios</h1>
                                <h1 class="text-xl font-bold text-gray-800 block sm:hidden">峠 GR</h1>
                            </div>

                            <!-- Nav Desktop Centralizada -->
                            <nav class="hidden md:block mx-auto">
                                <div class="flex space-x-4 border-b border-gray-200">
                                    ${tabLinks}
                                </div>
                            </nav>
                            
                            <!-- Usuﾃ｡rio e Logout ﾃ Direita -->
                            <div class="flex-1 flex justify-end items-center space-x-4">
                                <span class="text-sm font-medium text-gray-600 hidden sm:inline">
                                    Olﾃ｡, ${currentUser.name}
                                </span>
                                <!-- NOVO: Botﾃ｣o de Perfil Pessoal -->
                                <button onclick="updateState('settingTab', 'my-profile'); updateState('page', 'settings');" class="text-gray-500 hover:text-green-main transition-colors p-1 rounded-full hover:bg-gray-100" title="Meu Perfil / Gerenciar Senha">
                                    ${getUserAvatar(currentUser)}
                                </button>
                                <button onclick="handleLogout()" class="text-gray-500 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-gray-100" title="Sair do Sistema">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </header>
                <!-- Nav Mobile -->
                <nav class="bg-white border-t border-gray-200 fixed bottom-0 left-0 right-0 z-10 md:hidden shadow-2xl">
                    <div class="flex justify-around">
                        ${tabLinks.replace(/hidden sm:inline/g, '')}
                    </div>
                </nav>
                <div class="h-16 md:hidden"></div> <!-- Spacer for mobile nav -->
            `;
        }
        
        function renderLogin() {
            return `
                <!-- Fundo escuro para visual futurﾃｭstico -->
                <div class="flex items-center justify-center min-h-screen bg-gray-900">
                    <div class="w-full max-w-md p-8 space-y-8 bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl border border-green-main/30">
                        <div class="text-center">
                            <img src="https://usinapitangueiras.com.br/wp-content/uploads/2020/04/usina-pitangueiras-logo.png" alt="Logo Usina Pitangueiras"	
                                class="mx-auto h-20 w-auto mb-4"	
                                onerror="this.onerror=null; this.src='https://placehold.co/150x80/40800c/FFFFFF?text=Logo'; this.alt='Logo Placeholder'">
                            <h2 class="text-3xl font-extrabold text-gray-900">
                                Acesso ao Sistema
                            </h2>
                            <p class="mt-2 text-sm text-gray-600">
                                Use seu email e senha para continuar
                            </p>
                        </div>
                        <form id="login-form" class="mt-8 space-y-6">
                            <input type="email" id="email" placeholder="Email" required	
                                class="appearance-none relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-green-main focus:border-green-main focus:z-10 sm:text-sm shadow-sm"
                                value="monitoramentocoa1986@gmail.com"
                            >
                            <div class="relative">
                                <input type="password" id="password" placeholder="Senha" required	
                                    class="appearance-none relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-green-main focus:border-green-main focus:z-10 sm:text-sm shadow-sm pr-10"
                                    value="tmotvini1986@#"
                                >
                                <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700 focus:outline-none" title="Mostrar/Ocultar Senha">
                                    <i id="toggle-password-icon" class="fas fa-eye"></i>
                                </button>
                            </div>
                            
                            <button type="submit"	
                                class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-green-main hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-main transition-all shadow-md">
                                <i class="fas fa-lock mr-2"></i>
                                Entrar
                            </button>
                        </form>
                        <p class="text-xs text-center text-gray-500">
                            Usina Pitangueiras - "A ENERGIA QUE MOVE A REGIﾃグ"
                        </p>
                    </div>
                </div>
            `;
        }
        
        function renderLoadingScreen() {
            return `
                <div class="flex flex-col items-center justify-center min-h-screen bg-gray-900">
                    <!-- Imagem Inteira e Transiﾃｧﾃ｣o Suave (nﾃ｣o mais em cﾃｭrculo) -->
                    <img src="https://usinapitangueiras.com.br/wp-content/uploads/2020/04/usina-pitangueiras-logo.png" alt="Logo Usina Pitangueiras"	
                        class="h-40 w-auto mb-10 loader-logo-full"	
                        onerror="this.onerror=null; this.src='https://placehold.co/200x100/40800c/FFFFFF?text=Logo'; this.alt='Logo Placeholder'">
                        
                    <h1 class="text-3xl font-extrabold text-green-main tracking-widest loading-text-animate">
                        SISTEMA Rﾃ．IOS
                    </h1>
                    <p class="mt-4 text-sm text-gray-300 italic loading-text-animate">Aguarde o carregamento...</p>
                </div>
            `;
        }
        
        // --- Funﾃｧﾃｵes para ﾃ皇ones SVG (Design mais moderno e controlﾃ｡vel) ---
        function getRadioIcon() {
            // Sﾃｭmbolo de rﾃ｡dio/onda (ajustado para a nova cor)
            return `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect>
                    <line x1="12" y1="4" x2="12" y2="20"></line>
                    <path d="M5 8h2M5 12h2M5 16h2M17 8h2M17 12h2M17 16h2"></path>
                    <circle cx="12" cy="12" r="3" fill="#ffffff" stroke="none"></circle>
                </svg>
            `;
        }

        function getActiveRadioIcon() {
            // Sﾃｭmbolo de torre de transmissﾃ｣o (ajustado para a nova cor)
            return `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v6"></path>
                    <path d="M16 4h4a2 2 0 0 1 2 2v2M8 4H4a2 2 0 0 0-2 2v2"></path>
                    <path d="M20 12h2M2 12h2"></path>
                    <path d="M18 16h4a2 2 0 0 1 2 2v2M6 16H2a2 2 0 0 0-2 2v2"></path>
                    <circle cx="12" cy="12" r="3" fill="#ffffff" stroke="none"></circle>
                    <path d="M12 15v7"></path>
                </svg>
            `;
        }

        function getMaintenanceIcon() {
            // Sﾃｭmbolo de Chave de manutenﾃｧﾃ｣o (ajustado para a nova cor)
            return `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.4 1.4a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.77 3.77z"></path>
                </svg>
            `;
        }

        function getWarehouseIcon() {
            // Sﾃｭmbolo de estoque/armazﾃｩm (ajustado para a nova cor)
            return `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 21V8a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v13"></path>
                    <path d="M3 13h18"></path>
                    <path d="M3 17h18"></path>
                    <path d="M10 3L12 6L14 3"></path>
                    <rect x="5" y="10" width="4" height="4" rx="1"></rect>
                    <rect x="15" y="10" width="4" height="4" rx="1"></rect>
                </svg>
            `;
        }

        function renderDashboard() {
            const radioMap = dbRadios.reduce((acc, r) => { acc[r.id] = r; return acc; }, {});
            const activeDbRadios = dbRadios.filter(r => r.ativo !== false);

            const radioStats = {
                total: activeDbRadios.length,
                ativos: 0,
                manutencao: 0,
                estoque: 0,
            };
            
            activeDbRadios.forEach(r => {
                if (dbRegistros.some(reg => reg.radioId === r.id)) radioStats.ativos++;
                else if (r.status === 'Manutenﾃｧﾃ｣o') radioStats.manutencao++;
                else radioStats.estoque++;	
            });
            
            const groupCounts = {};
            GROUPS.forEach(g => groupCounts[g] = 0);
            
            dbRegistros.forEach(reg => {
                const equipamento = dbEquipamentos.find(eq => eq.id === reg.equipamentoId && eq.ativo !== false);
                if (equipamento) {
                    groupCounts[equipamento.grupo] = (groupCounts[equipamento.grupo] || 0) + 1;
                }
            });

            const cardData = [
                // Usando a nova cor verde e SVGs
                { title: 'Total de Rﾃ｡dios (Ativos)', value: radioStats.total, iconSvg: getRadioIcon(), color: 'bg-green-main' }, 
                { title: 'Rﾃ｡dios Ativos (Em Frota)', value: radioStats.ativos, iconSvg: getActiveRadioIcon(), color: 'bg-indigo-500' },
                { title: 'Rﾃ｡dios em Manutenﾃｧﾃ｣o', value: radioStats.manutencao, iconSvg: getMaintenanceIcon(), color: 'bg-yellow-600' },
                { title: 'Rﾃ｡dios Em Estoque (Disponﾃｭvel)', value: radioStats.estoque, iconSvg: getWarehouseIcon(), color: 'bg-blue-600' },
            ];
            
            const cardHtml = cardData.map(card => `
                <div class="bg-white rounded-xl p-6 shadow-xl futuristic-card border border-gray-100">
                    <div class="flex flex-col items-start space-y-3">
                        <div class="p-3 rounded-xl ${card.color} text-white shadow-lg flex items-center justify-center">
                            ${card.iconSvg}
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500 uppercase tracking-widest">${card.title}</p>
                            <p class="text-4xl font-extrabold text-gray-900 mt-1">${card.value}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            const tableRows = GROUPS.map(group => {
                const count = groupCounts[group] || 0;
                const letter = settings.letterMap[group] || 'N/A';	
                return `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${group}	
                            <span class="text-xs font-semibold text-gray-400">(${letter})</span>
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-700">${count}</td>
                    </tr>
                `;
            }).join('');
            
            const totalEquipamentos = dbRegistros.length;

            return `
                <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    <!-- Tﾃｭtulo Centralizado -->
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Dashboard de Rﾃ｡dios e Frota</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                        ${cardHtml}
                    </div>
                    <div class="bg-white rounded-xl shadow-xl p-6 border border-gray-200 futuristic-card">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-boxes mr-2 text-green-main"></i>	
                            Equipamentos com Rﾃ｡dio Ativo (Total: ${totalEquipamentos})
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grupo</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rﾃ｡dios Ativos</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCadastro() {
            const tabs = [
                { id: 'radio', name: 'Rﾃ｡dio' },
                { id: 'equipamento', name: 'Equipamentos' },
                { id: 'geral', name: 'Geral' }
            ];
            
            const tabNav = tabs.map(tab => {
                const isActive = currentCadastroTab === tab.id;
                const activeClass = isActive ? 'text-green-main border-green-main font-semibold' : 'text-gray-500 border-transparent hover:text-green-main';
                return `<button data-tab="${tab.id}" class="py-2 px-4 border-b-2 ${activeClass} transition-colors text-sm sm:text-base">${tab.name}</button>`;
            }).join('');
            
            let content = '';
            switch (currentCadastroTab) {
                case 'radio': content = renderCadastroRadio(); break;
                case 'equipamento': content = renderCadastroEquipamento(); break;
                case 'geral': content = renderCadastroGeral(); break;
            }

            return `
                <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    <!-- Tﾃｭtulo Centralizado -->
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Cadastro de Rﾃ｡dios e Equipamentos</h2>
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                        <div id="cadastro-nav" class="flex border-b border-gray-200 px-6 pt-2 overflow-x-auto">${tabNav}</div>
                        <div class="p-6">${content}</div>
                    </div>
                </div>
            `;
        }

        function renderCadastroRadio() {
            // Conta apenas os ativos para o tﾃｭtulo
            const activeRadiosCount = dbRadios.filter(r => r.ativo !== false).length;

            // Filtra por termo de busca em todos os rﾃ｡dios (ativos e inativos)
            const filteredRadios = dbRadios.filter(r =>	
                r.serie.toLowerCase().includes(radioSearch) ||	
                r.modelo.toLowerCase().includes(radioSearch)
            );

            // Ordena: Ativos primeiro, Inativos por ﾃｺltimo. Dentro de cada grupo, ordena por sﾃｩrie.
            filteredRadios.sort((a, b) => {
                const aAtivo = a.ativo !== false;
                const bAtivo = b.ativo !== false;

                if (aAtivo && !bAtivo) return -1; // Ativo vem antes do inativo
                if (!aAtivo && bAtivo) return 1;  // Inativo vem depois do ativo
                
                // Se o status for o mesmo (ambos ativos ou ambos inativos), ordena por sﾃｩrie.
                return a.serie.localeCompare(b.serie);
            });
            
            const totalRadioPages = Math.ceil(filteredRadios.length / PAGE_SIZE);
            radioPage = Math.min(radioPage, totalRadioPages) || 1;
            const paginatedRadios = filteredRadios.slice((radioPage - 1) * PAGE_SIZE, radioPage * PAGE_SIZE);

            const tableRows = paginatedRadios.map(r => {
                const isAtivo = r.ativo !== false;
                const rowClass = isAtivo ? 'hover:bg-gray-50 border-b' : 'hover:bg-red-50 border-b opacity-60 italic';
                const statusText = isAtivo ? r.status || 'Disponﾃｭvel' : 'INATIVO';
                const statusClass = isAtivo ? (r.status === 'Disponﾃｭvel' ? 'text-green-main' : (r.status === 'Manutenﾃｧﾃ｣o' ? 'text-yellow-600' : 'text-blue-600')) : 'text-red-600';
                
                // Usa text-gray-700 para manter a cor do texto do item inativo em cinza, 
                // apenas a coluna do status e a linha de fundo muda.
                return `
                    <tr class="${rowClass}">
                        <td class="px-4 py-2 text-sm text-gray-700 font-mono">${r.serie}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${r.modelo}</td>
                        <td class="px-4 py-2 text-sm font-semibold ${statusClass}">${statusText}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="loadRadioForEdit('${r.id}')" class="text-indigo-600 hover:text-indigo-900 p-1 rounded-full hover:bg-indigo-50" title="Editar Rﾃ｡dio">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${(() => {
                                const actionText = isAtivo ? 'INATIVAR' : 'ATIVAR';
                                // Invertendo a lﾃｳgica da cor do ﾃｭcone no toggle: se ATIVO, mostra o ﾃｭcone verde, se INATIVO, mostra o ﾃｭcone cinza.
                                const iconClass = isAtivo ? 'fa-toggle-on text-green-main' : 'fa-toggle-off text-gray-500'; 
                                const btnClass = isAtivo ? 'hover:text-red-900' : 'hover:text-green-main';
                                const title = isAtivo ? 'Inativar Rﾃ｡dio' : 'Ativar Rﾃ｡dio';
                                return `
                                <button onclick="showConfirmModal('Confirmar ${actionText}ﾃﾃグ', 'Deseja realmente ${actionText} o Rﾃ｡dio ${r.serie}?', () => toggleRecordAtivo('radios', '${r.id}'))" class="${btnClass} p-1 rounded-full hover:bg-gray-100" title="${title}">
                                    <i class="fas ${iconClass} fa-lg"></i>
                                </button>
                                `;
                            })()}
                        </td>
                    </tr>
                `;
            }).join('');

            let radioPaginator = '';
            if (filteredRadios.length > PAGE_SIZE) {
                radioPaginator = '<div class="flex justify-center items-center space-x-2 mt-4">';
                radioPaginator += `<button ${radioPage === 1 ? 'disabled' : ''} onclick="radioPage--; renderApp();" class="px-2 py-1 text-sm rounded-md ${radioPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-gray-200 hover:bg-gray-300'}">Anterior</button>`;
                radioPaginator += `<span class="text-sm font-medium text-gray-700">Pﾃ｡g ${radioPage} de ${totalRadioPages}</span>`;
                radioPaginator += `<button ${radioPage === totalRadioPages ? 'disabled' : ''} onclick="radioPage++; renderApp();" class="px-2 py-1 text-sm rounded-md ${radioPage === totalRadioPages ? 'bg-gray-100 text-gray-400' : 'bg-gray-300 hover:bg-gray-400'}">Prﾃｳxima</button>`;
                radioPaginator += '</div>';
            }

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Formulﾃ｡rio de Rﾃ｡dio -->
                    <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Novo/Editar Rﾃ｡dio</h4>
                        <form id="form-radio" class="space-y-4">
                            <input type="hidden" id="radio-id">
                            <div>
                                <label for="radio-serie" class="block text-sm font-medium text-gray-700">Nﾃｺmero de Sﾃｩrie <span class="text-red-500">*</span></label>
                                <input type="text" id="radio-serie" required placeholder="Ex: 112sar234s"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border">
                            </div>
                            <div>
                                <label for="radio-modelo" class="block text-sm font-medium text-gray-700">Modelo de Rﾃ｡dio <span class="text-red-500">*</span></label>
                                <input type="text" id="radio-modelo" required placeholder="Ex: EM200"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border">
                            </div>
                            <div>
                                <label for="radio-status" class="block text-sm font-medium text-gray-700">Status</label>
                                <select id="radio-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border bg-white">
                                    <option value="Disponﾃｭvel">Disponﾃｭvel</option>
                                    <option value="Manutenﾃｧﾃ｣o">Manutenﾃｧﾃ｣o</option>
                                    <option value="Em Uso" disabled>Em Uso (automﾃ｡tico)</option>
                                </select>
                            </div>
                            <div class="flex space-x-3">
                                <button type="submit" class="flex-1 w-full flex justify-center py-2 px-3 border border-transparent text-sm font-medium rounded-lg text-white bg-green-main hover:bg-green-700 shadow-md">
                                    <i class="fas fa-save mr-2"></i> Salvar
                                </button>
                                <button type="button" onclick="document.getElementById('form-radio').reset(); document.getElementById('radio-id').value='';" class="w-1/4 flex justify-center py-2 px-3 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-100 shadow-sm">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </form>
                        <input type="file" id="radio-import-file" accept=".csv, .xlsx" class="hidden" onchange="handleImport('radios', event)">
                        <button onclick="document.getElementById('radio-import-file').click()" class="w-full mt-4 flex justify-center py-2 px-3 border border-transparent text-sm font-medium rounded-lg text-white bg-indigo-500 hover:bg-indigo-600 shadow-md">
                            <i class="fas fa-upload mr-2"></i> Importar (csv, xlsx)
                        </button>
                    </div>

                    <!-- Tabela de Rﾃ｡dios -->
                    <div class="lg:col-span-2">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                            <h4 class="text-lg font-semibold text-gray-800">Rﾃ｡dios Cadastrados (Ativos: ${activeRadiosCount})</h4>
                            <input type="text" id="radio-search-input" value="${radioSearch}"	
                                oninput="handleSearchInput(this, 'radioSearch', 1)"	
                                placeholder="Buscar Sﾃｩrie ou Modelo..."	
                                class="rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border text-sm w-full sm:w-1/2">
                        </div>
                        <div class="bg-white border rounded-xl shadow-inner overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sﾃｩrie</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Modelo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aﾃｧﾃｵes</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                            </table>
                        </div>
                        ${radioPaginator}
                    </div>
                </div>
            `;
        }

        function renderCadastroEquipamento() {
            // Conta apenas os ativos para o tﾃｭtulo
            const activeEquipamentosCount = dbEquipamentos.filter(e => e.ativo !== false).length;

            // Filtra por termo de busca em todos os equipamentos (ativos e inativos)
            const filteredEquipamentos = dbEquipamentos.filter(e =>	
                e.frota.toLowerCase().includes(equipamentoSearch) ||
                e.grupo.toLowerCase().includes(equipamentoSearch) ||
                e.modelo.toLowerCase().includes(equipamentoSearch) ||
                (e.subgrupo || '').toLowerCase().includes(equipamentoSearch)
            );

            // Ordena: Ativos primeiro, Inativos por ﾃｺltimo. Dentro de cada grupo, ordena por frota.
            filteredEquipamentos.sort((a, b) => {
                const aAtivo = a.ativo !== false;
                const bAtivo = b.ativo !== false;

                if (aAtivo && !bAtivo) return -1; // Ativo vem antes do inativo
                if (!aAtivo && bAtivo) return 1;  // Inativo vem depois do ativo

                // Se o status for o mesmo, ordena por frota
                return a.frota.localeCompare(b.frota);
            });

            const totalEquipamentoPages = Math.ceil(filteredEquipamentos.length / PAGE_SIZE);
            equipamentoPage = Math.min(equipamentoPage, totalEquipamentoPages) || 1;
            const paginatedEquipamentos = filteredEquipamentos.slice((equipamentoPage - 1) * PAGE_SIZE, equipamentoPage * PAGE_SIZE);
            
            const tableRows = paginatedEquipamentos.map(e => {
                const isAtivo = e.ativo !== false;
                const rowClass = isAtivo ? 'hover:bg-gray-50 border-b' : 'hover:bg-red-50 border-b opacity-60 italic';
                const frotaClass = isAtivo ? 'text-gray-700' : 'text-red-700';

                return `
                    <tr class="${rowClass}">
                        <td class="px-4 py-2 text-sm ${frotaClass} font-mono">${e.frota} ${isAtivo ? '' : '(INATIVO)'}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${e.grupo}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${e.modelo}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 hidden md:table-cell">${e.subgrupo || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 hidden lg:table-cell">${e.gestor || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="loadEquipamentoForEdit('${e.id}')" class="text-indigo-600 hover:text-indigo-900 p-1 rounded-full hover:bg-indigo-50" title="Editar Equipamento">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${(() => {
                                const actionText = isAtivo ? 'INATIVAR' : 'ATIVAR';
                                // Invertendo a lﾃｳgica da cor do ﾃｭcone no toggle
                                const iconClass = isAtivo ? 'fa-toggle-on text-green-main' : 'fa-toggle-off text-gray-500';
                                const btnClass = isAtivo ? 'hover:text-red-900' : 'hover:text-green-main';
                                const title = isAtivo ? 'Inativar Equipamento' : 'Ativar Equipamento';
                                return `
                                <button onclick="showConfirmModal('Confirmar ${actionText}ﾃﾃグ', 'Deseja realmente ${actionText} o Equipamento ${e.frota}?', () => toggleRecordAtivo('equipamentos', '${e.id}'))" class="${btnClass} p-1 rounded-full hover:bg-gray-100" title="${title}">
                                    <i class="fas ${iconClass} fa-lg"></i>
                                </button>
                                `;
                            })()}
                        </td>
                    </tr>
                `;
            }).join('');
            
            const groupOptions = GROUPS.map(g => `<option value="${g}">${g}</option>`).join('');

            let equipamentoPaginator = '';
            if (filteredEquipamentos.length > PAGE_SIZE) {
                equipamentoPaginator = '<div class="flex justify-center items-center space-x-2 mt-4">';
                equipamentoPaginator += `<button ${equipamentoPage === 1 ? 'disabled' : ''} onclick="equipamentoPage--; renderApp();" class="px-2 py-1 text-sm rounded-md ${equipamentoPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-gray-200 hover:bg-gray-300'}">Anterior</button>`;
                equipamentoPaginator += `<span class="text-sm font-medium text-gray-700">Pﾃ｡g ${equipamentoPage} de ${totalEquipamentoPages}</span>`;
                equipamentoPaginator += `<button ${equipamentoPage === totalEquipamentoPages ? 'disabled' : ''} onclick="equipamentoPage++; renderApp();" class="px-2 py-1 text-sm rounded-md ${equipamentoPage === totalEquipamentoPages ? 'bg-gray-100 text-gray-400' : 'bg-gray-300 hover:bg-gray-400'}">Prﾃｳxima</button>`;
                equipamentoPaginator += '</div>';
            }

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Formulﾃ｡rio de Equipamento -->
                    <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Novo/Editar Equipamento</h4>
                        <form id="form-equipamento" class="space-y-4">
                            <input type="hidden" id="equipamento-id">
                            <div>
                                <label for="equipamento-frota" class="block text-sm font-medium text-gray-700">Frota <span class="text-red-500">*</span></label>
                                <input type="text" id="equipamento-frota" required placeholder="Ex: 123456"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border">
                            </div>
                            <div>
                                <label for="equipamento-grupo" class="block text-sm font-medium text-gray-700">Grupo <span class="text-red-500">*</span></label>
                                <select id="equipamento-grupo" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border bg-white">
                                    <option value="">Selecione o Grupo</option>
                                    ${groupOptions}
                                </select>
                            </div>
                            <div>
                                <label for="equipamento-modelo" class="block text-sm font-medium text-gray-700">Modelo do Equipamento <span class="text-red-500">*</span></label>
                                <input type="text" id="equipamento-modelo" required placeholder="Ex: Trator XYZ"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border">
                            </div>
                            <div>
                                <label for="equipamento-subgrupo" class="block text-sm font-medium text-gray-700">Subgrupo <span class="text-red-500">*</span></label>
                                <input type="text" id="equipamento-subgrupo" required placeholder="Ex: Ferirrigaﾃｧﾃ｣o, Tratos Culturais"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border">
                            </div>
                            <div>
                                <label for="equipamento-gestor" class="block text-sm font-medium text-gray-700">Gestor (Opcional)</label>
                                <input type="text" id="equipamento-gestor" placeholder="Ex: Joﾃ｣o da Silva"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border">
                            </div>
                            <div class="flex space-x-3">
                                <button type="submit" class="flex-1 w-full flex justify-center py-2 px-3 border border-transparent text-sm font-medium rounded-lg text-white bg-green-main hover:bg-green-700 shadow-md">
                                    <i class="fas fa-save mr-2"></i> Salvar
                                </button>
                                <button type="button" onclick="document.getElementById('form-equipamento').reset(); document.getElementById('equipamento-id').value='';" class="w-1/4 flex justify-center py-2 px-3 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-100 shadow-sm">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </form>
                        <input type="file" id="equipamento-import-file" accept=".csv, .xlsx" class="hidden" onchange="handleImport('equipamentos', event)">
                        <button onclick="document.getElementById('equipamento-import-file').click()" class="w-full mt-4 flex justify-center py-2 px-3 border border-transparent text-sm font-medium rounded-lg text-white bg-indigo-500 hover:bg-indigo-600 shadow-md">
                            <i class="fas fa-upload mr-2"></i> Importar (csv, xlsx)
                        </button>
                    </div>
                    <!-- Tabela de Equipamentos -->
                    <div class="lg:col-span-2">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                            <h4 class="text-lg font-semibold text-gray-800">Equipamentos Cadastrados (Ativos: ${activeEquipamentosCount})</h4>
                            <input type="text" id="equip-search-input" value="${equipamentoSearch}"	
                                oninput="handleSearchInput(this, 'equipamentoSearch', 1)"	
                                placeholder="Buscar Frota, Grupo ou Modelo..."	
                                class="rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border text-sm w-full sm:w-1/2">
                        </div>
                        <div class="bg-white border rounded-xl shadow-inner overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Frota</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Grupo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Modelo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Subgrupo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">Gestor</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aﾃｧﾃｵes</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                            </table>
                        </div>
                        ${equipamentoPaginator}
                    </div>
                </div>
            `;
        }
        
        function renderCadastroGeral() {
            const radioMap = dbRadios.reduce((acc, r) => { acc[r.id] = r; return acc; }, {});
            const equipamentoMap = dbEquipamentos.reduce((acc, e) => { acc[e.id] = e; return acc; }, {});
            
            const availableRadios = dbRadios.filter(r =>	
                r.ativo !== false &&	
                r.status === 'Disponﾃｭvel' &&	
                !dbRegistros.some(reg => reg.radioId === r.id)	
            );
            
            const availableEquipamentos = dbEquipamentos.filter(e =>	
                e.ativo !== false &&	
                !dbRegistros.some(reg => reg.equipamentoId === e.id)	
            );
            
            const radioOptions = availableRadios
                .map(r => `<option value="${r.id}">${r.serie} (${r.modelo})</option>`)
                .join('');
            const frotaOptions = availableEquipamentos
                .map(e => `<option value="${e.id}">${e.frota}</option>`)
                .join('');
            
            const filteredRegistros = dbRegistros.filter(reg => {
                const r = radioMap[reg.radioId] || {};
                const e = equipamentoMap[reg.equipamentoId] || {};
                const search = geralSearch.toLowerCase();
                return (
                    (e.codigo || reg.codigo || '').toLowerCase().includes(search) || // Busca pelo cﾃｳdigo do equipamento
                    (r.serie || '').toLowerCase().includes(search) ||
                    (e.frota || '').toLowerCase().includes(search) ||
                    (e.grupo || '').toLowerCase().includes(search)
                );
            });

            const totalGeralPages = Math.ceil(filteredRegistros.length / PAGE_SIZE);
            geralPage = Math.min(geralPage, totalGeralPages) || 1;
            const paginatedRegistros = filteredRegistros.slice((geralPage - 1) * PAGE_SIZE, geralPage * PAGE_SIZE);
            
            const tableRows = paginatedRegistros.map(reg => {
                const r = radioMap[reg.radioId] || { serie: 'N/A', modelo: 'N/A' };
                const e = equipamentoMap[reg.equipamentoId] || { frota: 'N/A', grupo: 'N/A', subgrupo: 'N/A', codigo: null };
                const codigo = e.codigo || reg.codigo || 'N/A'; // Prioriza cﾃｳdigo do equipamento
                
                return `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-4 py-2 text-sm text-gray-700 font-mono">${codigo}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${r.serie}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${e.frota}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 hidden sm:table-cell">${e.grupo}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 hidden md:table-cell">${e.subgrupo || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                            <button onclick="showConfirmModal('Confirmar Desvinculaﾃｧﾃ｣o', 'Deseja realmente desvincular o Rﾃ｡dio ${r.serie} da Frota ${e.frota}?', () => deleteRecord('registros', '${reg.id}'))" class="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-50" title="Desvincular Rﾃ｡dio">
                                <i class="fas fa-unlink"></i> Desvincular
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            let geralPaginator = '';
            if (filteredRegistros.length > PAGE_SIZE) {
                geralPaginator = '<div class="flex justify-center items-center space-x-2 mt-4">';
                geralPaginator += `<button ${geralPage === 1 ? 'disabled' : ''} onclick="geralPage--; renderApp();" class="px-2 py-1 text-sm rounded-md ${geralPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-gray-200 hover:bg-gray-300'}">Anterior</button>`;
                geralPaginator += `<span class="text-sm font-medium text-gray-700">Pﾃ｡g ${geralPage} de ${totalGeralPages}</span>`;
                geralPaginator += `<button ${geralPage === totalGeralPages ? 'disabled' : ''} onclick="geralPage++; renderApp();" class="px-2 py-1 text-sm rounded-md ${geralPage === totalGeralPages ? 'bg-gray-100 text-gray-400' : 'bg-gray-300 hover:bg-gray-400'}">Prﾃｳxima</button>`;
                geralPaginator += '</div>';
            }

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Formulﾃ｡rio de Associaﾃｧﾃ｣o -->
                    <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Gerar Cﾃｳdigo e Associar</h4>
                        <form id="form-geral" class="space-y-4">
                            <div>
                                <label for="geral-radio-id" class="block text-sm font-medium text-gray-700">Nﾃｺmero de Sﾃｩrie (Rﾃ｡dio) <span class="text-red-500">*</span></label>
                                <select id="geral-radio-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border bg-white">
                                    <option value="">Selecione um Rﾃ｡dio Disponﾃｭvel</option>
                                    ${radioOptions}
                                </select>
                                <p id="radio-modelo-info" class="mt-1 text-xs text-gray-500"></p>
                            </div>
                            <div>
                                <label for="geral-equipamento-id" class="block text-sm font-medium text-gray-700">Frota (Equipamento) <span class="text-red-500">*</span></label>
                                <select type="text" id="geral-equipamento-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border bg-white">
                                    <option value="">Selecione a Frota</option>
                                    ${frotaOptions}
                                </select>
                            </div>
                            <div id="equipamento-info" class="space-y-2 text-sm p-3 bg-white rounded-lg border">
                                <p><span class="font-semibold">Grupo:</span> <span id="info-grupo">N/A</span></p>
                                <p><span class="font-semibold">Subgrupo:</span> <span id="info-subgrupo">N/A</span></p>	
                                <p><span class="font-semibold">Gestor:</span> <span id="info-gestor">N/A</span></p>
                                <p><span class="font-semibold">Cﾃｳdigo:</span> <span id="info-codigo">N/A</span></p>
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-3 border border-transparent text-sm font-medium rounded-lg text-white bg-green-main hover:bg-green-700 shadow-md">
                                <i class="fas fa-barcode mr-2"></i> Gerar e Cadastrar
                            </button>
                        </form>
                    </div>
                    <!-- Tabela de Registros -->
                    <div class="lg:col-span-2">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                            <h4 class="text-lg font-semibold text-gray-800">Registros Ativos (Total: ${dbRegistros.length})</h4>
                            <input type="text" id="geral-search-input" value="${geralSearch}"	
                                oninput="handleSearchInput(this, 'geralSearch', 1)"	
                                placeholder="Buscar Cﾃｳdigo, Sﾃｩrie ou Frota..."	
                                class="rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border text-sm w-full sm:w-1/2">
                        </div>
                        <div class="bg-white border rounded-xl shadow-inner overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cﾃｳdigo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sﾃｩrie Rﾃ｡dio</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Frota</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Grupo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Subgrupo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aﾃｧﾃｵes</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                            </table>
                        </div>
                        ${geralPaginator}
                    </div>
                </div>
            `;
        }

        function renderPesquisa() {
            const allRecords = dbRegistros.map(reg => {
                const r = dbRadios.find(r => r.id === reg.radioId) || {};
                const e = dbEquipamentos.find(e => e.id === reg.equipamentoId) || {};
                return {
                    id: reg.id,	
                    codigo: e.codigo || reg.codigo, // Prioriza cﾃｳdigo do equipamento
                    serie: r.serie || 'N/A',
                    modeloRadio: r.modelo || 'N/A', frota: e.frota || 'N/A',
                    grupo: e.grupo || 'N/A', subgrupo: e.subgrupo || 'N/A',
                    gestor: e.gestor || 'N/A', createdAt: reg.createdAt
                };
            });
            
            let filteredRecords = allRecords;
            const searchInputElement = document.getElementById('search-term');
            const currentSearchTerm = searchInputElement ? searchInputElement.value : (window._searchTermTemp || '');	
            const searchTerm = currentSearchTerm.toLowerCase();

            if (searchTerm) {
                filteredRecords = allRecords.filter(r =>	
                    (r.codigo || '').toLowerCase().includes(searchTerm) ||
                    (r.serie || '').toLowerCase().includes(searchTerm) ||
                    (r.modeloRadio || '').toLowerCase().includes(searchTerm) ||
                    (r.frota || '').toLowerCase().includes(searchTerm) ||
                    (r.grupo || '').toLowerCase().includes(searchTerm) ||
                    (r.subgrupo || '').toLowerCase().includes(searchTerm) ||
                    (r.gestor || '').toLowerCase().includes(searchTerm)
                );
            }
            
            const tableRows = filteredRecords.map(r => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="px-4 py-2 text-sm font-semibold text-gray-900 font-mono">${r.codigo}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${r.frota} / ${r.grupo}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 hidden sm:table-cell">${r.serie} / ${r.modeloRadio}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 hidden md:table-cell">${r.subgrupo}</td>
                    <td class="px-4 py-2 text-sm text-gray-700 hidden lg:table-cell">${r.gestor}</td>
                </tr>
            `).join('');


            return `
                <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    <!-- Tﾃｭtulo Centralizado -->
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Pesquisa de Registros Ativos</h2>
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                        <div class="mb-4 flex space-x-2">
                            <input type="text" id="search-term" placeholder="Buscar por Cﾃｳdigo, Sﾃｩrie, Frota, Subgrupo..."	
                                value="${currentSearchTerm}"	
                                oninput="handleSearchInput(this, '_searchTermTemp')"
                                class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border"
                            >
                            <button id="search-button" onclick="document.getElementById('search-term').dispatchEvent(new Event('input'))" class="py-2 px-3 border border-transparent text-sm font-medium rounded-lg text-white bg-green-main hover:bg-green-700 shadow-md" title="Iniciar Busca">
                                <i class="fas fa-search"></i> <span class="hidden sm:inline">Buscar</span>
                            </button>
                        </div>
                        
                        <h4 class="text-lg font-semibold text-gray-800 mb-4 mt-6">Resultados (${filteredRecords.length})</h4>
                        <div class="bg-white border rounded-xl shadow-inner overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cﾃｳdigo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Equipamento (Frota/Grupo)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Rﾃ｡dio (Sﾃｩrie/Modelo)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Subgrupo</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">Gestor</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSettings() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            const tabs = [
                { id: 'my-profile', name: 'Meu Perfil', icon: 'fa-user' }, // NOVA ABA
                { id: 'system', name: 'Mapeamento', icon: 'fa-sitemap' },
                { id: 'users', name: 'Usuﾃ｡rios', icon: 'fa-users', requiredRole: 'admin' },
            ];

            const filteredTabs = tabs.filter(tab => !tab.requiredRole || (tab.requiredRole === 'admin' && isAdmin) || tab.id === 'my-profile');

            const tabNav = filteredTabs.map(tab => {
                const isActive = currentSettingTab === tab.id;
                const activeClass = isActive ? 'text-green-main border-green-main font-semibold' : 'text-gray-500 border-transparent hover:text-green-main';
                return `
                    <a href="#settings/${tab.id}" class="py-2 px-4 border-b-2 ${activeClass} transition-colors text-sm sm:text-base flex items-center space-x-2">
                        <i class="fas ${tab.icon}"></i>
                        <span>${tab.name}</span>
                    </a>
                `;
            }).join('');
            
            let content = '';
            switch (currentSettingTab) {
                case 'my-profile':
                    content = renderSettingsMyProfile();
                    break;
                case 'system':
                    content = renderSettingsSystem();
                    break;
                case 'users':
                    content = isAdmin ? "Carregando usuﾃ｡rios..." : `<p class="p-6 text-red-500 font-semibold">Acesso negado. Apenas administradores podem gerenciar usuﾃ｡rios.</p>`;
                    if (isAdmin) {
                        content = '<!-- Conteﾃｺdo de usuﾃ｡rios serﾃ｡ injetado apﾃｳs carregar dados de usuﾃ｡rios -->';
                    }
                    break;
                default:
                    currentSettingTab = 'my-profile'; // Redireciona default
                    content = renderSettingsMyProfile();
            }

            return `
                <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                    <!-- Tﾃｭtulo Centralizado -->
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Configuraﾃｧﾃｵes do Sistema</h2>
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                        <div id="settings-nav" class="flex border-b border-gray-200 px-6 pt-2 overflow-x-auto">${tabNav}</div>
                        <div id="settings-content" class="p-6">${content}</div>
                    </div>
                </div>
            `;
        }
        
        function renderSettingsMyProfile() {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-4xl">
                    <!-- 1. Gerenciar Nome de Exibiﾃｧﾃ｣o -->
                    <div class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-user-edit mr-2 text-green-main"></i> Gerenciar Nome de Exibiﾃｧﾃ｣o
                        </h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Altere o nome que aparece na barra superior do sistema.
                        </p>
                        <form id="form-personal-name" class="space-y-4">
                            <div>
                                <label for="profile-name" class="block text-sm font-medium text-gray-700">Nome de Exibiﾃｧﾃ｣o Atual</label>
                                <input type="text" id="profile-name" required value="${currentUser.name}"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-3 border border-transparent text-sm font-medium rounded-lg text-white bg-green-main hover:bg-green-700 shadow-md">
                                <i class="fas fa-save mr-2"></i> Salvar Nome
                            </button>
                        </form>
                        <div class="mt-4 p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-700">
                            <p><span class="font-semibold">Seu Email (Username):</span> ${currentUser.email}</p>
                            <p><span class="font-semibold">Seu Perfil:</span> ${currentUser.role.toUpperCase()}</p>
                        </div>
                    </div>
                    
                    <!-- 2. Alterar Senha -->
                    <div class="bg-gray-50 p-6 rounded-xl shadow-inner border border-red-200">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-key mr-2 text-red-600"></i> Alterar Senha
                        </h4>
                        <p class="text-sm text-red-600 mb-4">
                            Atenﾃｧﾃ｣o: Vocﾃｪ pode precisar fazer login novamente apﾃｳs a alteraﾃｧﾃ｣o. A nova senha deve ter no mﾃｭnimo 6 caracteres.
                        </p>
                        <form id="form-change-password" class="space-y-4">
                            <div>
                                <label for="profile-new-password" class="block text-sm font-medium text-gray-700">Nova Senha</label>
                                <input type="password" id="profile-new-password" required minlength="6"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border">
                            </div>
                            <div>
                                <label for="profile-confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Nova Senha</label>
                                <input type="password" id="profile-confirm-password" required minlength="6"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-3 border border-transparent text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 shadow-md">
                                <i class="fas fa-lock mr-2"></i> Alterar Senha
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderSettingsSystem() {
            const currentMap = settings.letterMap;
            const nextIndex = settings.nextIndex;
            
            const groupInputs = GROUPS.map(group => {
                const prefix = currentMap[group] || '';
                const indexKey = prefix === 'NUM' ? 'NUM' : prefix;
                const nextNum = nextIndex[indexKey] || 1;	
                const nextCodeDisplay = prefix ? (prefix === 'NUM' ? zpad(nextNum, 3) : prefix + zpad(nextNum, 3)) : 'N/A';

                return `
                    <div class="flex items-center space-x-4 border-b pb-3 mb-3">
                        <label class="w-1/3 text-sm font-medium text-gray-700">${group}</label>
                        <input type="text" id="map-${group.replace(/\s/g, '')}" value="${prefix}" required maxlength="3"
                            class="w-1/4 rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border text-center font-mono uppercase"
                        >
                        <div class="w-1/4 text-sm text-gray-500">
                            Prﾃｳximo: ${nextCodeDisplay}	
                        </div>
                    </div>`;
            }).join('');

            return `
                <h4 class="text-xl font-semibold text-gray-800 mb-6">Mapeamento de Letras por Grupo</h4>
                <form id="form-settings-system" class="space-y-4 max-w-lg">
                    <p class="text-sm text-gray-600 mb-4">Defina a letra ou cﾃｳdigo para o prefixo do Cﾃｳdigo de Rastreamento. Use 'NUM' para cﾃｳdigo sequencial.</p>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner border">
                        <div class="flex items-center space-x-4 font-bold text-sm text-gray-800 border-b-2 pb-2 mb-3">
                            <span class="w-1/3">Grupo</span>
                            <span class="w-1/4 text-center">Prefixo</span>
                            <span class="w-1/4">Prﾃｳx. Cﾃｳdigo</span>
                        </div>
                        ${groupInputs}
                    </div>
                    <button type="submit" class="flex justify-center py-2 px-3 border border-transparent text-sm font-medium rounded-lg text-white bg-green-main hover:bg-green-700 shadow-md">
                        <i class="fas fa-save mr-2"></i> Salvar Mapeamento
                    </button>
                </form>
            `;
        }

        /**
         * [CORREﾃﾃグ] Funﾃｧﾃ｣o de eventos de Usuﾃ｡rios movida para o escopo global.
         */
        function attachSettingsUsersEvents() {
            const form = document.getElementById('form-user');
            if (form) {
                form.onsubmit = saveUser;
                const resetButton = document.getElementById('user-reset-btn');
                if (resetButton) {
                    resetButton.onclick = () => {
                        form.reset();
                        document.getElementById('user-id').value = '';
                        document.getElementById('user-form-title').textContent = 'Novo Perfil de Usuﾃ｡rio';
                    };
                }
            }
        }

        // Funﾃｧﾃ｣o de renderizaﾃｧﾃ｣o de Usuﾃ｡rios com Formulﾃ｡rio de CRUD
        async function renderSettingsUsers() {
            // Recarrega lista de usuﾃ｡rios (para garantir dados frescos para a renderizaﾃｧﾃ｣o)
            const settingsDocRef = doc(db, "artifacts", appId, "public", "data", "settings", "config");
            const settingsSnap = await getDoc(settingsDocRef);
            const usersFromDB = settingsSnap.exists() ? settingsSnap.data().users || [] : [];
            settings.users = usersFromDB;	

            const tableRows = usersFromDB.map(u => {
                const isMainAdmin = u.username === 'monitoramentocoa1986@gmail.com';
                const isCurrent = currentUser.uid === u.uid;
                const canEditDelete = !isMainAdmin;

                return `
                    <tr class="hover:bg-gray-50 border-b ${isCurrent ? 'bg-indigo-50/50' : ''}">
                        <td class="px-4 py-2 text-sm font-medium text-gray-900">${u.name} ${isCurrent ? '<span class="text-xs text-indigo-500">(Vocﾃｪ)</span>' : ''}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${u.username}</td>
                        <td class="px-4 py-2 text-sm font-semibold ${u.role === 'admin' ? 'text-green-main' : 'text-blue-600'}">${u.role.toUpperCase()}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="loadUserForEdit('${u.id}')" ${canEditDelete ? '' : 'disabled'} class="text-indigo-600 hover:text-indigo-900 p-1 rounded-full hover:bg-indigo-50 ${canEditDelete ? '' : 'opacity-50 cursor-not-allowed'}" title="Editar Perfil">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="showPermissionModal('${u.id}')" ${canEditDelete ? '' : 'disabled'} class="text-green-600 hover:text-green-900 p-1 rounded-full hover:bg-green-50 ${canEditDelete ? '' : 'opacity-50 cursor-not-allowed'}" title="Alterar permissﾃｵes">
                                <i class="fas fa-user-cog"></i>
                            </button>
                            <button onclick="showConfirmModal('Confirmar Exclusﾃ｣o', 'Deseja realmente excluir o perfil de ${u.name}? Isso ﾃｩ irreversﾃｭvel.', () => deleteUser('${u.id}'))" ${canEditDelete ? '' : 'disabled'} class="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-50 ${canEditDelete ? '' : 'opacity-50 cursor-not-allowed'}" title="Excluir Perfil">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Formulﾃ｡rio de Criaﾃｧﾃ｣o/Ediﾃｧﾃ｣o de Usuﾃ｡rio -->
                    <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-200">
                        <h4 id="user-form-title" class="text-lg font-semibold text-gray-800 mb-4">Novo Perfil de Usuﾃ｡rio</h4>
                        <form id="form-user" class="space-y-4">
                            <input type="hidden" id="user-id">
                            <div>
                                <label for="user-name" class="block text-sm font-medium text-gray-700">Nome Completo <span class="text-red-500">*</span></label>
                                <input type="text" id="user-name" required placeholder="Ex: Maria da Silva"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border">
                            </div>
                            <div>
                                <label for="user-username" class="block text-sm font-medium text-gray-700">Username (Email) <span class="text-red-500">*</span></label>
                                <input type="email" id="user-username" required placeholder="exemplo@empresa.com.br"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border">
                                <p class="text-xs text-gray-500 mt-1">Deve ser o mesmo email usado para login no Firebase Auth.</p>
                            </div>
                            <div>
                                <label for="user-role" class="block text-sm font-medium text-gray-700">Perfil/Role <span class="text-red-500">*</span></label>
                                <select id="user-role" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-main focus:ring-green-main p-2 border bg-white">
                                    <option value="user">Usuﾃ｡rio Padrﾃ｣o</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                            <div class="flex space-x-3">
                                <button type="submit" class="flex-1 w-full flex justify-center py-2 px-3 border border-transparent text-sm font-medium rounded-lg text-white bg-green-main hover:bg-green-700 shadow-md">
                                    <i class="fas fa-save mr-2"></i> Salvar Perfil
                                </button>
                                <button type="button" id="user-reset-btn" class="w-1/4 flex justify-center py-2 px-3 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-100 shadow-sm">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Tabela de Usuﾃ｡rios -->
                    <div class="lg:col-span-2">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Perfis Cadastrados (Total: ${usersFromDB.length})</h4>
                        <div class="bg-white border rounded-xl shadow-inner overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Username (Email)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Perfil</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aﾃｧﾃｵes</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                            </table>
                        </div>
                        <p class="mt-4 text-sm text-yellow-600">
                            A exclusﾃ｣o ou ediﾃｧﾃ｣o do usuﾃ｡rio principal (Admin) ﾃｩ bloqueada. 
                            As permissﾃｵes de um novo usuﾃ｡rio ou de um 'admin' sﾃ｣o definidas automaticamente no salvamento.
                        </p>
                    </div>
                </div>
            `;
        }
        
        // --- Funﾃｧﾃｵes de Eventos (DOM) ---

        function handleSearchInput(inputElement, stateVariable, pageToReset = null) {
            const value = inputElement.value;
            const cursorPos = inputElement.selectionStart;
            focusedSearchInputId = inputElement.id;	
            searchCursorPosition = cursorPos;	

            if (stateVariable === 'radioSearch') radioSearch = value.toLowerCase();
            else if (stateVariable === 'equipamentoSearch') equipamentoSearch = value.toLowerCase();
            else if (stateVariable === 'geralSearch') geralSearch = value.toLowerCase();
            else if (stateVariable === '_searchTermTemp') window._searchTermTemp = value;	
            
            if (pageToReset) {
                if (stateVariable === 'radioSearch') radioPage = 1;
                else if (stateVariable === 'equipamentoSearch') equipamentoPage = 1;
                else if (stateVariable === 'geralSearch') geralPage = 1;
            }

            renderApp();
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                showModal('Erro', 'Nﾃ｣o foi possﾃｭvel sair. Tente novamente.', 'error');
            }
        }

        async function handleLoginSubmit(e) {
            e.preventDefault();
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const email = emailInput.value;
            const password = passwordInput.value;
            
            isLoggingIn = true;
            renderApp();	

            try {
                await signInWithEmailAndPassword(auth, email, password);
                
            } catch (error) {
                console.error("Erro de login:", error.code);
                isLoggingIn = false;
                renderApp();	
                
                let msg = 'Email ou senha invﾃ｡lidos. Tente novamente.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    msg = 'Email ou senha invﾃ｡lidos.';
                } else if (error.code === 'auth/invalid-email') {
                    msg = 'O formato do email ﾃｩ invﾃ｡lido.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    msg = 'Login por Email/Senha nﾃ｣o estﾃ｡ ativado no Firebase.';
                }
                showModal('Erro de Login', msg, 'error');
            }
        }

        async function fetchAppUserProfile(email) {
            if (!db || !appId) return null;
            
            // [CORREﾃﾃグ] Usa appId hardcoded
            const settingsDocRef = doc(db, "artifacts", appId, "public", "data", "settings", "config");
            try {
                const settingsSnap = await getDoc(settingsDocRef);
                if (settingsSnap.exists()) {
                    const allUsers = settingsSnap.data().users || [];
                    settings.users = allUsers;	
                    const appUser = allUsers.find(u => u.username === email);	
                    return appUser || null;
                } else {
                    console.error("'settings/config' nﾃ｣o encontrado.");
                    return null;
                }
            } catch (e) {
                console.error("Erro ao buscar perfil de usuﾃ｡rio:", e);
                return null;
            }
        }

        function attachLoginEvents() {
            const form = document.getElementById('login-form');
            const passwordInput = document.getElementById('password');
            const togglePasswordButton = document.getElementById('toggle-password');
            const togglePasswordIcon = document.getElementById('toggle-password-icon');

            if (form) {
                form.onsubmit = handleLoginSubmit;	
                
                if (passwordInput) {
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') handleLoginSubmit(e);
                    });
                }
                if (togglePasswordButton) {
                    togglePasswordButton.addEventListener('click', () => {
                        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                        passwordInput.setAttribute('type', type);
                        togglePasswordIcon.classList.toggle('fa-eye');
                        togglePasswordIcon.classList.toggle('fa-eye-slash');
                    });
                }
            }
        }

        function attachCadastroEvents() {
            const nav = document.getElementById('cadastro-nav');
            if(nav) {
                nav.onclick = (e) => {
                    const button = e.target.closest('button');
                    if (button) {
                        const tabId = button.dataset.tab;
                        if (tabId && tabId !== currentCadastroTab) {
                            updateState('cadastroTab', tabId);
                        }
                    }
                };
            }
            
            if (currentCadastroTab === 'radio') attachCadastroRadioEvents();
            else if (currentCadastroTab === 'equipamento') attachCadastroEquipamentoEvents();
            else if (currentCadastroTab === 'geral') attachCadastroGeralEvents();
        }
        
        function attachCadastroRadioEvents() {
            const form = document.getElementById('form-radio');
            if (form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('radio-id').value;
                    const serie = document.getElementById('radio-serie').value.trim();
                    const modelo = document.getElementById('radio-modelo').value.trim();
                    const status = document.getElementById('radio-status').value;
                    
                    if (!serie || !modelo) {
                        showModal('Erro', 'Nﾃｺmero de Sﾃｩrie e Modelo sﾃ｣o obrigatﾃｳrios.', 'error');
                        return;
                    }
                    
                    if ((!id || (id && dbRadios.find(r=>r.id===id)?.serie !== serie)) && dbRadios.some(r => r.serie === serie)) {
                        showModal('Erro', 'Este Nﾃｺmero de Sﾃｩrie jﾃ｡ estﾃ｡ cadastrado.', 'error');
                        return;
                    }

                    const record = { id, serie, modelo, status };
                    
                    if (id) {
                        const existingRadio = dbRadios.find(r => r.id === id);
                        if (existingRadio && existingRadio.status === 'Em Uso' && status !== 'Em Uso') {
                            record.status = 'Em Uso';	
                            showModal('Aviso', 'O status "Em Uso" sﾃｳ pode ser alterado na aba "Geral".', 'warning');
                        }
                    }

                    await saveRecord('radios', record);	
                    
                    form.reset();
                    document.getElementById('radio-id').value = '';
                };
            }
        }

        function loadRadioForEdit(id) {
            const radio = dbRadios.find(r => r.id === id);
            if (radio) {
                document.getElementById('radio-id').value = radio.id;
                document.getElementById('radio-serie').value = radio.serie;
                document.getElementById('radio-modelo').value = radio.modelo;
                document.getElementById('radio-status').value = radio.status || 'Disponﾃｭvel';
                
                const statusSelect = document.getElementById('radio-status');
                const emUsoOption = statusSelect.querySelector('option[value="Em Uso"]');
                if (emUsoOption) {
                    if (radio.status === 'Em Uso') {
                        emUsoOption.disabled = false;
                    } else {
                        emUsoOption.disabled = true;
                    }
                }
                
                showModal('Ediﾃｧﾃ｣o', `Carregando Rﾃ｡dio ${radio.serie} para ediﾃｧﾃ｣o.`, 'info');
                window.scrollTo(0, 0);
            } else {
                showModal('Erro', 'Rﾃ｡dio nﾃ｣o encontrado.', 'error');
            }
        }

        function attachCadastroEquipamentoEvents() {
            const form = document.getElementById('form-equipamento');
            if (form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('equipamento-id').value;
                    const frota = document.getElementById('equipamento-frota').value.trim();
                    const grupo = document.getElementById('equipamento-grupo').value;
                    const modelo = document.getElementById('equipamento-modelo').value.trim();
                    const subgrupo = document.getElementById('equipamento-subgrupo').value.trim();
                    const gestor = document.getElementById('equipamento-gestor').value.trim() || 'Sem Gestor';
                    
                    if (!frota || !grupo || !modelo || !subgrupo) {
                        showModal('Erro', 'Todos os campos, exceto Gestor, sﾃ｣o obrigatﾃｳrios.', 'error');
                        return;
                    }
                    
                    if ((!id || (id && dbEquipamentos.find(eq=>eq.id===id)?.frota !== frota)) && dbEquipamentos.some(eq => eq.frota === frota)) {
                        showModal('Erro', 'Esta Frota jﾃ｡ estﾃ｡ cadastrada.', 'error');
                        return;
                    }

                    const record = { id, frota, grupo, modelo, subgrupo, gestor };
                    await saveRecord('equipamentos', record);	
                    
                    form.reset();
                    document.getElementById('equipamento-id').value = '';
                };
            }
        }

        function loadEquipamentoForEdit(id) {
            const equipamento = dbEquipamentos.find(e => e.id === id);
            if (equipamento) {
                document.getElementById('equipamento-id').value = equipamento.id;
                document.getElementById('equipamento-frota').value = equipamento.frota;
                document.getElementById('equipamento-grupo').value = equipamento.grupo;
                document.getElementById('equipamento-modelo').value = equipamento.modelo;
                document.getElementById('equipamento-subgrupo').value = equipamento.subgrupo;
                document.getElementById('equipamento-gestor').value = equipamento.gestor === 'Sem Gestor' ? '' : equipamento.gestor;
                showModal('Ediﾃｧﾃ｣o', `Carregando Frota ${equipamento.frota} para ediﾃｧﾃ｣o.`, 'info');
                window.scrollTo(0, 0);
            } else {
                showModal('Erro', 'Equipamento nﾃ｣o encontrado.', 'error');
            }
        }
        
        function attachCadastroGeralEvents() {
            const radioSelect = document.getElementById('geral-radio-id');
            const equipamentoSelect = document.getElementById('geral-equipamento-id');
            
            if (radioSelect) {
                radioSelect.onchange = () => {
                    const radioId = radioSelect.value;
                    const infoEl = document.getElementById('radio-modelo-info');
                    if(infoEl){
                        if (radioId) {
                            const radio = dbRadios.find(r => r.id === radioId);
                            infoEl.textContent = `Modelo: ${radio ? radio.modelo : 'N/A'}`;
                        } else {
                            infoEl.textContent = '';
                        }
                    }
                };
                radioSelect.dispatchEvent(new Event('change'));
            }
            
            if (equipamentoSelect) {
                equipamentoSelect.onchange = () => {
                    const equipamentoId = equipamentoSelect.value;
                    const infoGrupo = document.getElementById('info-grupo');
                    const infoSubgrupo = document.getElementById('info-subgrupo');
                    const infoGestor = document.getElementById('info-gestor');
                    
                    if(infoGrupo && infoSubgrupo && infoGestor){	
                        if (equipamentoId) {
                            const equipamento = dbEquipamentos.find(e => e.id === equipamentoId);
                            if (equipamento) {
                                infoGrupo.textContent = equipamento.grupo;
                                infoSubgrupo.textContent = equipamento.subgrupo;
                                infoGestor.textContent = equipamento.gestor;

                                // [NOVO] Mostra o cﾃｳdigo do equipamento, se existir
                                const infoCodigo = document.getElementById('info-codigo');
                                if (infoCodigo) {
                                    if (equipamento.codigo) {
                                        infoCodigo.innerHTML = `<span class="font-bold text-green-main">${equipamento.codigo}</span> (Cﾃｳdigo jﾃ｡ vinculado)`;
                                    } else {
                                        infoCodigo.innerHTML = `<span class="font-semibold text-yellow-600">Nenhum</span> (Serﾃ｡ gerado ao salvar)`;
                                    }
                                }
                            } else {
                                infoGrupo.textContent = 'N/A'; infoSubgrupo.textContent = 'N/A'; infoGestor.textContent = 'N/A';
                                document.getElementById('info-codigo').textContent = 'N/A';
                            }
                        } else {
                            infoGrupo.textContent = 'N/A'; infoSubgrupo.textContent = 'N/A'; infoGestor.textContent = 'N/A';
                            document.getElementById('info-codigo').textContent = 'N/A';
                        }
                    }
                };
                equipamentoSelect.dispatchEvent(new Event('change'));
            }

            const form = document.getElementById('form-geral');
            if (form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const radioId = radioSelect.value;
                    const equipamentoId = equipamentoSelect.value;
                    
                    if (!radioId || !equipamentoId) {
                        showModal('Erro', 'Selecione um Rﾃ｡dio e uma Frota vﾃ｡lidos.', 'error');
                        return;
                    }
                    
                    if (dbRegistros.some(reg => reg.equipamentoId === equipamentoId)) {
                        showModal('Erro', 'Esta Frota jﾃ｡ possui um Rﾃ｡dio ativo.', 'error');
                        return;
                    }
                    if (dbRegistros.some(reg => reg.radioId === radioId)) {
                        showModal('Erro', 'Este Rﾃ｡dio jﾃ｡ estﾃ｡ em uso.', 'error');
                        return;
                    }

                    // [NOVA Lﾃ敵ICA DE Cﾃ泥IGO]
                    const equipamentoRef = doc(db, `artifacts/${appId}/public/data/equipamentos`, equipamentoId);
                    const equipamentoSnap = await getDoc(equipamentoRef);
                    
                    if (!equipamentoSnap.exists()) {
                        showModal('Erro', 'Equipamento nﾃ｣o encontrado.', 'error');
                        return;
                    }

                    const equipamento = { id: equipamentoSnap.id, ...equipamentoSnap.data() };
                    let codigoDoEquipamento = equipamento.codigo;

                    // Se o equipamento nﾃ｣o tiver um cﾃｳdigo, gera um novo e salva nele
                    if (!codigoDoEquipamento) {
                        codigoDoEquipamento = generateCode(equipamento.grupo);	
                        if (!codigoDoEquipamento) return; // Erro jﾃ｡ tratado em generateCode

                        try {
                            await updateDoc(equipamentoRef, { codigo: codigoDoEquipamento });
                            console.log(`Cﾃｳdigo ${codigoDoEquipamento} salvo no equipamento ${equipamentoId}`);
                        } catch (e) {
                            console.error("Erro ao salvar cﾃｳdigo no equipamento:", e);
                            showModal('Erro', 'Nﾃ｣o foi possﾃｭvel salvar o novo cﾃｳdigo no equipamento.', 'error');
                            return;
                        }
                    }
                    
                    const record = {
                        radioId,
                        equipamentoId,
                        codigo: codigoDoEquipamento, // Salva o cﾃｳdigo (novo ou existente) na associaﾃｧﾃ｣o
                        createdAt: new Date().toISOString()
                    };
                    
                    try {
                        // Salva o registro de associaﾃｧﾃ｣o
                        await saveRecord('registros', record);	
                        
                        // Atualiza o status do rﾃ｡dio
                        // [CORREﾃﾃグ] Usa appId hardcoded
                        const radioRef = doc(db, `artifacts/${appId}/public/data/radios`, radioId);
                        await updateDoc(radioRef, { status: 'Em Uso' });

                        showModal('Sucesso!', `Equipamento cadastrado! Cﾃｳdigo: ${codigoDoEquipamento}`, 'success');
                        
                        form.reset();
                        if(radioSelect) radioSelect.dispatchEvent(new Event('change'));
                        if(equipamentoSelect) equipamentoSelect.dispatchEvent(new Event('change'));
                    
                    } catch (error) {
                        console.error("Erro ao associar registro:", error);
                        showModal('Erro', 'Nﾃ｣o foi possﾃｭvel salvar a associaﾃｧﾃ｣o.', 'error');
                    }
                };
            }
        }

        function attachPesquisaEvents() {
            const searchButton = document.getElementById('search-button');
            if(searchButton){
                searchButton.onclick = () => {
                    const searchInput = document.getElementById('search-term');
                    if(searchInput) searchInput.dispatchEvent(new Event('input'));
                }
            }
        }

        function attachSettingsEvents() {
            if (currentSettingTab === 'my-profile') {
                attachSettingsMyProfileEvents();
            } else if (currentSettingTab === 'system') {
                attachSettingsSystemEvents();
            } else if (currentSettingTab === 'users' && currentUser && currentUser.role === 'admin') {
                attachSettingsUsersEvents(); 
            }
        }
        
        function attachSettingsMyProfileEvents() {
            const nameForm = document.getElementById('form-personal-name');
            if (nameForm) {
                nameForm.onsubmit = savePersonalName;
            }

            const passwordForm = document.getElementById('form-change-password');
            if (passwordForm) {
                passwordForm.onsubmit = changePassword;
            }
        }
        
        function attachSettingsSystemEvents() {
            const form = document.getElementById('form-settings-system');
            if (form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    let newLetterMap = {};
                    let isValid = true;
                    
                    GROUPS.forEach(group => {
                        const input = document.getElementById(`map-${group.replace(/\s/g, '')}`);
                        if (input) {
                            newLetterMap[group] = input.value.trim().toUpperCase();
                            if (!newLetterMap[group]) {
                                isValid = false;
                                showModal('Erro', `O prefixo para '${group}' nﾃ｣o pode ser vazio.`, 'error');
                            }
                        }
                    });

                    if (isValid) {
                        const newNextIndex = { ...settings.nextIndex };
                        Object.values(newLetterMap).forEach(prefix => {
                            const indexKey = prefix === 'NUM' ? 'NUM' : prefix;
                            if (newNextIndex[indexKey] === undefined) newNextIndex[indexKey] = 1;
                        });

                        settings.letterMap = newLetterMap;
                        settings.nextIndex = newNextIndex;	
                        
                        await saveSettings();	

                        showModal('Sucesso', 'Mapeamento de letras salvo!', 'success');
                        renderApp();	
                    }
                };
            }
        }

        async function showPermissionModal(userId)	
        {
            // [CORREﾃﾃグ] Usa appId hardcoded
            const settingsDocRef = doc(db, "artifacts", appId, "public", "data", "settings", "config");
            const settingsSnap = await getDoc(settingsDocRef);
            if (!settingsSnap.exists()) {
                showModal('Erro', 'Nﾃ｣o foi possﾃｭvel carregar os dados de usuﾃ｡rio.', 'error');
                return;
            }

            const usersFromDB = settingsSnap.data().users || [];
            const userIndex = usersFromDB.findIndex(u => u.id === userId);
            
            if (userIndex === -1) {
                showModal('Erro', 'Usuﾃ｡rio nﾃ｣o encontrado.', 'error');
                return;
            }
            
            const user = usersFromDB[userIndex];
            
            if (user.username === 'monitoramentocoa1986@gmail.com') {	
                showModal('Permissﾃｵes Fixas', 'As permissﾃｵes do usuﾃ｡rio Administrador principal sﾃ｣o fixas e nﾃ｣o podem ser alteradas.', 'warning');
                return;
            }

            const currentPerms = user.permissions || { dashboard: true, cadastro: true, pesquisa: true, settings: false };
            const allTabs = [
                { id: 'dashboard', name: 'Dashboard' }, { id: 'cadastro', name: 'Cadastro' },
                { id: 'pesquisa', name: 'Pesquisa' }, { id: 'settings', name: 'Configuraﾃｧﾃｵes' }
            ];

            const checkboxesHTML = allTabs.map(tab => `
                <div class="flex items-center">
                    <input id="perm-${tab.id}-${user.id}" type="checkbox" ${currentPerms[tab.id] ? 'checked' : ''} class="h-4 w-4 text-green-main border-gray-300 rounded focus:ring-green-main" ${tab.id === 'settings' && user.role !== 'admin' ? 'disabled' : ''}>
                    <label for="perm-${tab.id}-${user.id}" class="ml-2 block text-sm text-gray-900">
                        ${tab.name} 
                        ${tab.id === 'settings' && user.role !== 'admin' ? '<span class="text-xs text-red-500">(Admin-Only)</span>' : ''}
                    </label>
                </div>
            `).join('');

            const modal = document.getElementById('global-modal');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const actionsEl = document.getElementById('modal-actions');

            titleEl.textContent = `Permissﾃｵes de ${user.name}`;
            messageEl.innerHTML = `
                <p class="text-sm text-gray-600 mb-4">Selecione as abas que este usuﾃ｡rio pode acessar.</p>
                <div class="space-y-2">${checkboxesHTML}</div>
            `;
            titleEl.className = `text-xl font-bold mb-3 text-gray-800`;	

            actionsEl.innerHTML = `
                <button onclick="hideModal()" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 shadow-md">Cancelar</button>
                <button id="confirm-action-btn" class="px-3 py-1.5 text-sm bg-green-main text-white rounded-lg hover:bg-green-700 shadow-md">Salvar</button>
            `;
            
            document.getElementById('confirm-action-btn').onclick = async () => {
                const newPermissions = {};
                allTabs.forEach(tab => {
                    const checkbox = document.getElementById(`perm-${tab.id}-${user.id}`);	
                    if (checkbox) newPermissions[tab.id] = checkbox.checked;
                });
                
                usersFromDB[userIndex].permissions = newPermissions;
                
                try {
                    // [CORREﾃﾃグ] Usa appId hardcoded
                    await setDoc(settingsDocRef, { users: usersFromDB }, { merge: true });
                    hideModal();
                    showModal('Sucesso', `Permissﾃｵes de ${user.name} atualizadas.`, 'success');
                    // Se estiver editando as prﾃｳprias permissﾃｵes, forﾃｧa um novo check de Auth e render
                    if (currentUser.id === userId) {
                        currentUser.permissions = newPermissions;
                        handleHashChange();
                    } else {
                        renderApp();	
                    }
                } catch (e) {
                    console.error("Erro ao salvar permissﾃｵes:", e);
                    showModal('Erro', 'Nﾃ｣o foi possﾃｭvel salvar as permissﾃｵes.', 'error');
                }
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }


        // --- Funﾃｧﾃｵes Principais de Inicializaﾃｧﾃ｣o e Renderizaﾃｧﾃ｣o ---

        function handleHashChange() {
            if (!isAuthReady) return;	

            const hash = window.location.hash.substring(1);
            const parts = hash.split('/');
            const targetPage = parts[0] || (currentUser ? 'dashboard' : 'login');
            const subTab = parts.length > 1 ? parts[1] : null;
            
            if (targetPage === 'login' && currentUser) {
                window.history.pushState(null, null, `#${currentPage}`);
                return;
            }
            if (targetPage !== 'login' && !currentUser) {
                updateState('page', 'login');
                return;
            }
            
            const canAccessTargetPage = !currentUser || targetPage === 'login' || currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions[targetPage]);

            if (!canAccessTargetPage) {
                showModal('Acesso Negado', 'Vocﾃｪ nﾃ｣o tem permissﾃ｣o para acessar esta pﾃ｡gina.', 'error');
                window.history.pushState(null, null, `#${currentPage}`);	
                return;
            }

            if (targetPage && targetPage !== currentPage) {
                updateState('page', targetPage);
            }	
            else if (targetPage === 'cadastro' && subTab && subTab !== currentCadastroTab) {
                updateState('cadastroTab', subTab);
            } else if (targetPage === 'cadastro' && !subTab && currentCadastroTab !== 'radio') {
                updateState('cadastroTab', 'radio');
            }
            else if (targetPage === 'settings' && subTab && subTab !== currentSettingTab) {
                updateState('settingTab', subTab);
            } else if (targetPage === 'settings' && !subTab && currentSettingTab !== 'my-profile') {
                // Se nﾃ｣o houver sub-aba, forﾃｧamos para "Meu Perfil"
                updateState('settingTab', 'my-profile');
            }	
            else {
                renderApp();	
            }
        }
        
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const appUser = await fetchAppUserProfile(user.email);
                    
                    if (appUser) {
                        currentUser = { ...appUser, uid: user.uid, email: user.email };
                        isAuthReady = true;
                        isLoggingIn = false;	
                        await attachFirestoreListeners();	
                    } else {
                        showModal('Erro de Perfil', 'Login bem-sucedido, mas seu perfil (permissﾃｵes) nﾃ｣o foi encontrado no banco de dados. Contate o administrador.', 'error');
                        isAuthReady = true;	
                        isLoggingIn = false;
                        await handleLogout();	
                    }
                } else {
                    currentUser = null;
                    userId = null;
                    isAuthReady = true;
                    isLoggingIn = false;
                    detachFirestoreListeners();	
                    dbRadios = []; dbEquipamentos = []; dbRegistros = [];
                    updateState('page', 'login');	
                }
            });
        }


        /**
         * [CORREﾃﾃグ] Inicializa o Firebase com a constante hardcoded.
         */
        function initApp() {
            try {
                // Usa a constante FIREBASE_CONFIG hardcoded
                app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('info');	
                
                setupAuthListener();

            } catch (e) {
                console.error("Erro crﾃｭtico ao inicializar Firebase:", e);
                document.getElementById('app').innerHTML = `<div class="p-4 text-red-500 font-semibold text-center">Erro crﾃｭtico ao inicializar o Firebase. Verifique as configuraﾃｧﾃｵes e a conexﾃ｣o.</div>`;
            }
        }

        function renderApp() {
            const root = document.getElementById('app');
            let contentHTML = '';

            if (isLoggingIn) {
                contentHTML = renderLoadingScreen();
            } else if (currentUser) {
                contentHTML += renderTopBar();
                contentHTML += '<main class="pb-20 md:pb-8">';
                
                const canAccessCurrentPage = currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions[currentPage]);

                if (!canAccessCurrentPage && currentPage !== 'login') {
                    showModal('Acesso Negado', 'Vocﾃｪ nﾃ｣o tem permissﾃ｣o para acessar esta pﾃ｡gina.', 'error');
                    currentPage = 'dashboard';
                    window.location.hash = '#dashboard';
                    contentHTML += renderDashboard();
                } else {
                    switch (currentPage) {
                        case 'dashboard': contentHTML += renderDashboard(); break;
                        case 'cadastro': contentHTML += renderCadastro(); break;
                        case 'pesquisa': contentHTML += renderPesquisa(); break;
                        case 'settings': contentHTML += renderSettings(); break;
                        default:
                            currentPage = 'dashboard';
                            window.location.hash = '#dashboard';
                            contentHTML += renderDashboard();	
                    }
                }
                contentHTML += '</main>';
            } else if (isAuthReady) {
                currentPage = 'login';
                contentHTML += renderLogin();
            } else {
                contentHTML = renderLoadingScreen();
            }

            root.innerHTML = contentHTML;

            // Anexa eventos
            if (!isLoggingIn) {
                if (currentPage === 'login' && isAuthReady && !currentUser) {
                    attachLoginEvents();
                } else if (currentUser) {
                    if (currentPage === 'cadastro') attachCadastroEvents();
                    if (currentPage === 'pesquisa') attachPesquisaEvents();
                    
                    // [CORREﾃﾃグ] Chamada da funﾃｧﾃ｣o de eventos principal
                    if (currentPage === 'settings') attachSettingsEvents();
                }
            }
            
            // Renderiza conteﾃｺdo de usuﾃ｡rios apﾃｳs a renderizaﾃｧﾃ｣o principal (porque ﾃｩ assﾃｭncrono)
            if (currentUser && currentPage === 'settings' && currentSettingTab === 'users' && currentUser.role === 'admin') {
                renderSettingsUsers().then(html => {
                    const settingsContent = document.getElementById('settings-content');
                    if (settingsContent) settingsContent.innerHTML = html;
                    // Os eventos sﾃ｣o anexados DENTRO do then (attachSettingsUsersEvents), mas agora a funﾃｧﾃ｣o estﾃ｡ no escopo correto.
                });
            } else if (currentUser && currentPage === 'settings' && currentSettingTab === 'my-profile') {
                // Jﾃ｡ estﾃ｡ renderizado, sﾃｳ anexa eventos
                // Estes eventos sﾃ｣o anexados via attachSettingsEvents > attachSettingsMyProfileEvents
            }

            // Restaura o foco da busca
            if (focusedSearchInputId) {
                const focusedInput = document.getElementById(focusedSearchInputId);
                if (focusedInput) {
                    focusedInput.focus();
                    try { focusedInput.setSelectionRange(searchCursorPosition, searchCursorPosition); }	
                    catch (e) { /* ignora */ }
                }
            } else {
                window._searchTermTemp = '';	
            }
        }

        // --- Inicializaﾃｧﾃ｣o ---
        
        window.onhashchange = handleHashChange;
        
        window.handleLogout = handleLogout;
        window.handleSearchInput = handleSearchInput;
        window.loadRadioForEdit = loadRadioForEdit;
        window.loadEquipamentoForEdit = loadEquipamentoForEdit;
        window.showConfirmModal = showConfirmModal;
        window.hideModal = hideModal;
        window.handleImport = handleImport;
        window.showPermissionModal = showPermissionModal;
        window.renderApp = renderApp;	
        window.updateState = updateState;	
        window.deleteRecord = deleteRecord;	
        window.toggleRecordAtivo = toggleRecordAtivo; 
        
        // Funﾃｧﾃｵes CRUD de Usuﾃ｡rios
        window.loadUserForEdit = loadUserForEdit;
        window.deleteUser = deleteUser;
        
        window.onload = initApp;

    </script>
</body>
</html>


